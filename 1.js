!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.BasicLib=e():t.BasicLib=e()}(self,(function(){return(()=>{var t={757:(t,e,n)=>{t.exports=n(666)},15:(t,e)=>{e.b=function(t,e,n){t.setInt8(e,n)},e.s=function(t,e,n){t.setInt16(e,n,!0)},e.g=function(t,e,n){t.setInt32(e,n,!0)},e.buf=function(t,e,n){for(var r=0;r<n.byteLength;r++)t.setInt8(e+r,n[r])}},904:(t,e)=>{e.getShortYear=function(t){return(t.getFullYear()+"").substr(2,2)}},666:t=>{t=function(t){"use strict";var e,n=Object.prototype,r=n.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",o=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function c(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{c({},"")}catch(n){c=function(t,e,n){return t[e]=n}}function l(t,n,r,a){var i,o,s,c;n=n&&n.prototype instanceof p?n:p,n=Object.create(n.prototype),a=new D(a||[]);return n._invoke=(i=t,o=r,s=a,c=h,function(t,n){if(c===g)throw new Error("Generator is already running");if(c===f){if("throw"===t)throw n;return T()}for(s.method=t,s.arg=n;;){var r=s.delegate;if(r){var a=function t(n,r){var a;if((a=n.iterator[r.method])===e){if(r.delegate=null,"throw"===r.method){if(n.iterator.return&&(r.method="return",r.arg=e,t(n,r),"throw"===r.method))return v;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return v}return"throw"===(a=u(a,n.iterator,r.arg)).type?(r.method="throw",r.arg=a.arg,r.delegate=null,v):(a=a.arg)?a.done?(r[n.resultName]=a.value,r.next=n.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}(r,s);if(a){if(a===v)continue;return a}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if(c===h)throw c=f,s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);if(c=g,"normal"===(a=u(i,o,s)).type){if(c=s.done?f:d,a.arg!==v)return{value:a.arg,done:s.done}}else"throw"===a.type&&(c=f,s.method="throw",s.arg=a.arg)}}),n}function u(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}t.wrap=l;var h="suspendedStart",d="suspendedYield",g="executing",f="completed",v={};function p(){}function m(){}function b(){}var y={};c(y,i,(function(){return this})),(a=(a=Object.getPrototypeOf)&&a(a(L([]))))&&a!==n&&r.call(a,i)&&(y=a);var x=b.prototype=p.prototype=Object.create(y);function w(t){["next","throw","return"].forEach((function(e){c(t,e,(function(t){return this._invoke(e,t)}))}))}function I(t,e){var n;this._invoke=function(a,i){function o(){return new e((function(n,o){!function n(a,i,o,s){if("throw"!==(a=u(t[a],t,i)).type){var c=a.arg;return(i=c.value)&&"object"==typeof i&&r.call(i,"__await")?e.resolve(i.__await).then((function(t){n("next",t,o,s)}),(function(t){n("throw",t,o,s)})):e.resolve(i).then((function(t){c.value=t,o(c)}),(function(t){return n("throw",t,o,s)}))}s(a.arg)}(a,i,n,o)}))}return n=n?n.then(o,o):o()}}function C(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function S(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function D(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(C,this),this.reset(!0)}function L(t){if(t){if(n=t[i])return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n,a=-1;return(n=function n(){for(;++a<t.length;)if(r.call(t,a))return n.value=t[a],n.done=!1,n;return n.value=e,n.done=!0,n}).next=n}}return{next:T}}function T(){return{value:e,done:!0}}return c(x,"constructor",m.prototype=b),c(b,"constructor",m),m.displayName=c(b,s,"GeneratorFunction"),t.isGeneratorFunction=function(t){return!!(t="function"==typeof t&&t.constructor)&&(t===m||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,c(t,s,"GeneratorFunction")),t.prototype=Object.create(x),t},t.awrap=function(t){return{__await:t}},w(I.prototype),c(I.prototype,o,(function(){return this})),t.AsyncIterator=I,t.async=function(e,n,r,a,i){void 0===i&&(i=Promise);var o=new I(l(e,n,r,a),i);return t.isGeneratorFunction(n)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},w(x),c(x,s,"Generator"),c(x,i,(function(){return this})),c(x,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e,n=[];for(e in t)n.push(e);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=L,D.prototype={constructor:D,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(S),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function a(r,a){return s.type="throw",s.arg=t,n.next=r,a&&(n.method="next",n.arg=e),!!a}for(var i=this.tryEntries.length-1;0<=i;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return a("end");if(o.tryLoc<=this.prev){var c=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return a(o.catchLoc,!0);if(this.prev<o.finallyLoc)return a(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return a(o.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return a(o.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;0<=n;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}var o=(i=i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc?null:i)?i.completion:{};return o.type=t,o.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),S(n),v}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r,a=n.completion;return"throw"===a.type&&(r=a.arg,S(n)),r}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:L(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),v}},t}(t.exports);try{regeneratorRuntime=t}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}}},e={};function n(r){var a=e[r];return void 0!==a||(a=e[r]={exports:{}},t[r](a,a.exports,n)),a.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var r in e)n.o(e,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var r={};return(()=>{"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e){switch(s){case 0:91==t&&0==e&&(s=1);break;case 1:s=2,c=t;break;case 2:x(l,a++,t),4==a&&(u=l.getInt32(0,!0),n=new ArrayBuffer(4),l=new DataView(n),a=0,s=4);break;case 4:x(l,a++,t),2==a&&(h=l.getInt16(0,!0),n=new ArrayBuffer(4),l=new DataView(n),a=0,s=6);break;case 6:d=t,h<g?s=0:h==g?s=8:(f=h-g,s=7,v=new DataView(new ArrayBuffer(f)));break;case 7:x(v,h-g-f,t),0==--f&&(s=8,a=0);break;case 8:var n;x(l,a++,t),2==a&&(p=l.getInt16(0,!0),n=new ArrayBuffer(4),l=new DataView(n),a=0,s=9);break;case 9:if(s=0,93==t)return(o={}).checksum=p,o.cmd=c,o.cmds="0x"+c.toString(16),o.msgLength=h,o.param=v,o.state=d,o.seq=u,o.fallContent=i,o}}n.d(r,{default:()=>Dt});var a="",i=0,o=null,s=0,c=null,l=new DataView(new ArrayBuffer(4)),u=null,h=null,d=null,g=12,f=null,v=null,p=null,m=[0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64,1,192,128,65,0,193,129,64,0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64,0,193,129,64,1,192,128,65,0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64,1,192,128,65,0,193,129,64,0,193,129,64,1,192,128,65,0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64,0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64,1,192,128,65,0,193,129,64,0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64,0,193,129,64,1,192,128,65,0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64,0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64,1,192,128,65,0,193,129,64,0,193,129,64,1,192,128,65,0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64,1,192,128,65,0,193,129,64,0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64,0,193,129,64,1,192,128,65,0,193,129,64,1,192,128,65,1,192,128,65,0,193,129,64],b=[0,192,193,1,195,3,2,194,198,6,7,199,5,197,196,4,204,12,13,205,15,207,206,14,10,202,203,11,201,9,8,200,216,24,25,217,27,219,218,26,30,222,223,31,221,29,28,220,20,212,213,21,215,23,22,214,210,18,19,211,17,209,208,16,240,48,49,241,51,243,242,50,54,246,247,55,245,53,52,244,60,252,253,61,255,63,62,254,250,58,59,251,57,249,248,56,40,232,233,41,235,43,42,234,238,46,47,239,45,237,236,44,228,36,37,229,39,231,230,38,34,226,227,35,225,33,32,224,160,96,97,161,99,163,162,98,102,166,167,103,165,101,100,164,108,172,173,109,175,111,110,174,170,106,107,171,105,169,168,104,120,184,185,121,187,123,122,186,190,126,127,191,125,189,188,124,180,116,117,181,119,183,182,118,114,178,179,115,177,113,112,176,80,144,145,81,147,83,82,146,150,86,87,151,85,149,148,84,156,92,93,157,95,159,158,94,90,154,155,91,153,89,88,152,136,72,73,137,75,139,138,74,78,142,143,79,141,77,76,140,68,132,133,69,135,71,70,134,130,66,67,131,65,129,128,64],y=function(t,n){a=0;var r=new DataView(t);136==t.byteLength&&(i=1==r.getInt8(10)?1:0);for(var s=t.byteLength,c=0;c<s;c++)null!=(o=e(r.getInt8(c),c))&&n(o)},x=function(t,e,n){t.setInt8(e,n)};function w(t){for(var e=[],n=[],r=!0,a=t,i=(e=[a],n=[a],a);0<=--i;)e[i]=i,n[i]=0;this.init=function(t){if(r){for(var i=a;0<=--i;)n[i]=t;r=!1}else{var o=0;for(i=a;0<=--i;)0!=e[i]?e[i]--:(e[i]=a-1,n[i]=t,o=i);var s=0,c=0,l=0;for(l=0==o?a-(s=1):o==a-1?(s=0,a-2):n[o-1]<n[o]?(s=o+1,a-1):(s=0,o-1);s<=l;)c=Math.floor((s+l)/2),t<n[c]?l=c-1:s=c+1;if(o<=c){for(var u=o;u<s-1;u++)n[u]=n[u+1],e[u]=e[u+1];n[s-1]=t,e[s-1]=a-1}else{for(u=o;s<u;u--)n[u]=n[u-1],e[u]=e[u-1];n[s]=t,e[s]=a-1}}},this.getValue=function(t){return n[t]}}function I(t){for(var e=[],n=t,r=0,a=0,i=n;0<=--i;)e[i]=0;this.init=function(t){r-=e[a],r+=t,e[a]=t,++a==n&&(a=0)},this.getValue=function(){return r/n}}function C(){for(var t=[25],e=0,n=!0,r=0,a=0;a<25;a++)t[a]=0;this.init=function(a){if(r-=t[e],t[e]=a,r+=a,e++,n){if(25!=e)return 0;n=!1}return 25==e&&(e=0),r/25},this.getValue=function(){return t[(e+12)%25]}}function S(){for(var t=128,e=127,n=64,r=0,a=125,i=[t],o=[t],s=[t],c=[t],l=new w(250),u=0,h=0,d=0;d<t;d++)i[d]=0,o[d]=0,s[d]=0,c[d]=0;this.getLine=function(){var t=l.getValue(240);return t<2?2:t},this.init=function(e,h){var d=i[r];return i[a]=h,o[a]=e-h,l.init(Math.abs(e-h)),++a==t&&(a=0),this.sm10(),this.sm5(),++n==t&&(n=0),h=o[r],Math.abs(h)>this.getLine()?(u=20,d+=s[r]):d+=0==u?c[r]:10<=--u?s[r]:(s[r]+c[r])/2,++r==t&&(r=0),d},this.sm5=function(){var r=n-2+t;s[n]=(8*o[2+r&e]+o[1+r&e]+o[3+r&e]+o[r&e]+o[4+r&e])/12;var a=this.getLine();if(Math.abs(o[n])>a&&(r=1+r,Math.abs(o[r&e])<=a))for(var i=20;0<=--i;)10<i?(c[r-i&e]+=s[r-i&e],c[r-i&e]=c[r-i&e]/2):c[r-i&e]=s[r-i&e]},this.sm10=function(){var r=n-8+t;h-=o[r&e],h+=o[15+r&e],c[n]=h/15},this.sm101=function(){var r=n-7+t;c[n]=(o[2+r&e]+o[1+r&e]+o[3+r&e]+o[r&e]+o[4+r&e]+o[5+r&e]+o[6+r&e]+o[7+r&e]+o[8+r&e]+o[9+r&e]+o[10+r&e]+o[11+r&e]+o[12+r&e]+o[14+r&e]+o[13+r&e])/15}}function D(){for(var t=0,e=[15],n=0,r=0;r<15;r++)e[r]=0;this.init=function(r){return n-=e[t],n+=r,e[t++]=r,15==t&&(t=0),n/15},this.v=function(){return e[(t+7)%15]}}var L=[],T=0,E=0,A=-1,B=0,M=0;function N(t,e,n,r){if(0===r){M=B=0,r++,console.log("心率初始化");var a,i=new Array(e),o=[1];o[0]=0,H(t,e,i,o,n),G(t,e,i,o,n);var s=0;if(3<(a=o[0])){for(var c=new Array(a-1),l=1;l<a;l++)c[l-1]=parseInt(i[l]-i[l-1]);_(c,0,a-2);var u=0;if(1<(a-1)/2)o=parseInt((c[Math.floor((a-1)/2)]+c[Math.floor((a-1)/2-1)]+c[Math.floor((a-1)/2+1)])/3),s=parseInt(60*n/o);else{for(var h=1;h<a-2;h++)u=parseInt(u+c[h]);var d=parseInt(u/(a-3));s=parseInt(60*n/d)}null!=c&&(c=null)}else if(1<a){for(var g=new Array(a-1),f=1;f<a;f++)g[f-1]=i[f]-i[f-1];for(var v=0,p=0;p<a-1;p++)v+=g[p];d=parseInt(v/(a-1)),s=parseInt(60*n/d),null!=g&&(g=null)}else s=0;return _(s=[B,B=M,M=s],0,2),null!=i&&(i=null),Math.floor(s[1])}console.log("心率计算"),r++;var m,b=new Array(e);(r=[1])[0]=0,H(t,e,b,r,n),G(t,e,b,r,n),console.log("param[0]  :"+r[0]);var y=0,x=0;if(3<(m=r[0])){for(var w=new Array(m-1),I=1;I<m;I++)w[I-1]=b[I]-b[I-1];_(w,0,m-2);for(var C=w[m/2],S=0,D=0,L=0;L<m-1;L++)P(w[L]-C)<.2*C?(y+=parseInt(60*n/w[L]),S++):(x+=parseInt(60*n/w[L]),D++);y=0!=S?parseInt(y/S):parseInt(x/D),null!=w&&(w=null)}else if(1<m){for(var T=new Array(m-1),E=1;E<m;E++)T[E-1]=b[E]-b[E-1];for(var A=0,N=0;N<m-1;N++)A+=T[N];y=parseInt(60*n/(A/(m-1))),null!=T&&(T=null)}else y=0;return 150<y&&(y=y%10<5?10*Math.floor(y/10):10*(Math.floor(y/10)+1)),_(r=[B,B=M,M=y],0,2),null!=b&&(b=null),Math.floor(r[1]);function _(t,e,n){if(e<n){for(var r=e,a=n,i=t[e];r<a;){for(;r<a&&t[a]>=i;)a--;for(r<a&&(t[r++]=t[a]);r<a&&t[r]<=i;)r++;r<a&&(t[a--]=t[r])}t[r]=i,_(t,e,r-1),_(t,r+1,n)}}function j(t){return 0<=t?t:-1*t}function G(t,e,n,r,a){var i,o,s=0,c=0,l=0,u=[50],h=[50],d=[50],g=[50],f=0,v=0,p=0,m=0;for(s=1;s<e-1;)if(t[s]>t[s-1]&&t[s]>=t[s+1]&&30<t[s]&&p<50){for(u[p]=s,c=1;0<=s-c-1&&c<.2*a;){if(t[s-c-1]>=t[s-c]&&t[s-c+1]>t[s-c]){h[p]=s-c;break}c++}for(l=1;s+l+1<=e&&l<.2*a;){if(t[s+l+1]>=t[s+l]&&t[s+l-1]>t[s+l]){d[p]=s+l;break}l++}0<h[p]&&0<d[p]&&j((i=t[s]*(s-h[p])/(t[s]-t[h[p]]))-(o=t[s]*(d[p]-s)/(t[s]-t[h[p]])))<a/100&&(g[f]=i+o,v=g[f]+v,f++),s+=.2*a,p++}else s+=1;if(0<f&&(v/=f),4<p){var b=new Array(p-1);k(b,0,p-1);var y=new Array(p-1);k(y,0,p-1);var x=0,w=0,I=0;for(s=0;s<p-1;s++){for(b[s]=u[s+1]-u[s],c=d[s];c<h[s+1]-60;c++){for(l=w=x=0;l<60;l++){if(5<t[c+l]){w=1;break}if(0!=t[c+l])break;x++}if(1==w)break;if(60==x){y[s]=1;break}}I+=y[s]}if(_(b,0,p-2),1==(m=P(b[p-3]-b[1])<a/50&&p-4<=I&&p/2<I?1:m))if(0<v&&v<=.02*a)for(s=0;s<50;s++)u[s]=0,n[s]=u[s],r[0]=0;else if(.08*a<v)for(s=0;s<50;s++)n[s]=u[s],r[0]=p}return 1}function P(t){return(t=parseInt(t))<0?-t:t}function H(t,e,n,r,a){var i=parseInt(e/a),o=parseInt(e/i),s=.2,c=parseInt(s*a),l=new Array(e-1+c);k(l,0,e-1+c);for(var u=5;u<e-5;u++)l[u]=2*t[u]-t[u-5]-t[u+5];for(var h=1;h<e;h++)l[h-1]<0&&(l[h-1]=-l[h-1]);for(var d=0;d<e-1;d++)0==l[d]&&(l[d]=1e-4);for(var g=0;g<e-1;g++)l[g]=l[g]*Math.log(l[g]);for(var f,v=new Array(i),p=0,m=0;m<i;m++).1<(f=q(l,o*m,o-1))&&(v[p]=f,p++);W(v,0,p-1),console.log("m_index  "+JSON.stringify(v)),console.log("Math.floor   "+Math.floor(p/2));for(var b,y,x=.7*v[Math.floor(p/2)],w=(v[Math.floor(p/2)],x),I=1,C=0,S=new Array(e),D=1;I<e-s*a+c;)l[I-1]>x?(S[D-1]=I,(b=[1])[0]=0,y=O(l,I-1,s*a+1,b),parseInt(b[0]),x=.7*y.temp,w=x=1<D&&x>1.2*l[S[D-2]-1]?+l[S[D-2]-1]:x,C=0,I=parseInt(I+s*a),D++):(I++,(x=(1-.3*++C/(1.2*a))*w)<.25*w&&(x=.25*w));D--;for(var L=1;L<=D;L++){var T,E,A=0,B=0,M=0,N=0,_=parseInt(S[L-1]-10),G=parseInt(S[L-1]+10),P=(B=1<=_&&G<=e?((T=[1])[0]=A,M=O(t,_,G-_+1,T),A=parseInt(T[0]),T[0]=B,N=R(t,_,G-_+1,T),T[0]):_<1?((E=[_=1])[0]=A,M=O(t,_,G-_+1,E),A=parseInt(E[0]),E[0]=B,N=R(t,_,G-_+1,E),E[0]):(G=e,(E=[1])[0]=A,M=O(t,_,G-_+1,E),A=parseInt(E[0]),E[0]=B,N=R(t,_,G-_+1,E),E[0]),j(N.temp)>3*j(M.temp)?B:A);S[L-1]=parseInt(_+P)}var H=D;if(0==H)return null!=l&&(l=null),null!=S&&(S=null),null!=v&&(v=null),r[0]=0,1;var V=new Array(e);for(function(t,e,n){for(var r=0;r<n;r++)t[r]=e[r]}(V,S,H),u=0;u<H;u++)n[u]=V[u];return r[0]=H,v=S=l=V=null,1}}function k(t,e,n){for(var r=0;r<n;r++)t[r]=e}function q(t,e,n){for(var r=t[e],a=1;a<n;a++)r<=t[e+a]&&(r=t[e+a]);return r}function O(t,e,n,r){for(var a=t[e],i=0,o=1;o<n;o++)a<=t[e+o]&&(a=t[e+o],i=o);return r[0]=i,(r={}).temp=a,r.loc=i,r}function R(t,e,n,r){for(var a=t[e],i=0,o=1;o<n;o++)a>=t[e+o]&&(a=t[e+o],i=o);return r[0]=i,(r={}).temp=a,r.loc=i,r}function W(t,e,n){if(e<n){for(var r=e,a=n,i=t[e];r<a;){for(;r<a&&t[a]>=i;)a--;for(r<a&&(t[r++]=t[a]);r<a&&t[r]<=i;)r++;r<a&&(t[a--]=t[r])}t[r]=i,W(t,e,r-1),W(t,r+1,n)}}function _(t,e){if(t instanceof Array==1){var n=0==(1<arguments.length&&void 0!==e?e:0)?"00":"01",r=j(t),a=function(t,e){return t=(4*t+13).toString(16),String(t).length,(Array(4).join("0")+t+Array(3).join("0")).slice(-4)}(t.length),i=function(t){return 10<=t&&t<=15||1==String(t).length?"0"+t.toString(16):t.toString(16)}(t.length),o="2400000000".concat(a).concat(n).concat(i).concat(r);e=P(o),t="5b".concat(o).concat(e,"5d");return console.log("完整版补包参数",{status:n,repair0:r,PepairLength:a,packages:i,strCrc:o,str:e}),t}console.error("1003")}function j(t){for(var e=[],n=0;n<t.length;n++){var r=t[n].toString(16);e.push(r)}for(var a=[],i=0;i<e.length;i++){var o=G(e[i],8);a.push(o)}return a.join("")}function G(t,e){return(e=(Array(e).join(0)+t).slice(-e)).slice(6,8)+e.slice(4,6)+e.slice(2,4)+e.slice(0,2)}function P(t){t=new Uint8Array(t.match(/[\da-f]{2}/gi).map((function(t){return parseInt(t,16)}))).buffer;for(var e=new DataView(t),n=e.byteLength,r=[],a=0;a<n;a++)r.push(e.getInt8(a));return r.length,function(t,e,n){return function(t,e,n,r){for(var a,i=(65280&r)>>8,o=255&r,s=0;s<n;++s)a=255&(o^t[0+s]),o=i^m[a],i=b[a];return 3==(r=(r=(255&i)<<8|255&o).toString(16).toUpperCase()).length&&(r="0"+r),2==r.length&&(r="00"+r),1==r.length&&(r="000"+r),r.substr(2,2)+r.substr(0,2)}(t,0,n,0)}(r,0,r.length)}function H(t,e,n){t.setInt8(e,n)}function V(t,e,n){t.setInt16(e,n,!0)}function Q(t,e,n){t.setInt32(e,n,!0)}function F(t){for(var e,n=[],r=0;r<t.length;r++)1==t[r].toString(16).length?(e="0"+t[r].toString(16),n.push(e)):n.push(t[r].toString(16));return n.join("")}const U={EcgInteractive:function(t,e){if(null==t)console.error("1001");else{if(null!=e)return function(t,e){return t=new Uint8Array(t.match(/[\da-f]{2}/gi).map((function(t){return parseInt(t,16)}))),y(t.buffer,e)}(t,e);console.error("1001")}},remaining:function(t){if(null!=t)return(t/2).toFixed(0);console.error("1001")},IssueaAnOrder:function(){switch(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0){case 0:return{name:"1分钟快速监测模式",command:"5b213f0000000c0000ccd45d"};case 1:return{name:"睡眠模式",command:"5b21000000000c000282165d"};case 2:return{name:"获取SN号",command:"5B52000000000C000044E65D"};case 3:return{name:"停止模式命令",command:"5b21000000000c006343fe5d"};case 4:return{name:"历史数据上传命令",command:"5b21000000000c000402145d"};case 5:return{name:"24H动态检测模式",command:"5B21000000000c0005C3D45d"};case 6:return{name:"清除历史数据",command:"5b21010000000c0063533E5d"};default:return console.error("1002")}},ArrayQueue:function(){var t=[];this.push=function(e){return t.push(e),!0},this.pop=function(){return t.shift()},this.getFront=function(){return t[0]},this.getRear=function(){return t[t.length-1]},this.clear=function(){t=[]},this.size=function(){return t.length},this.value=function(e){return t[e]}},ab2hex:function(t){return Array.prototype.map.call(new Uint8Array(t),(function(t){return("00"+t.toString(16)).slice(-2)})).join("")},inArray:function(t,e,n){for(var r=0;r<t.length;r++)if(t[r][e]===n)return r;return-1},qrs_det:function(t,e){var n=1250;return function(t,e,n,r){for(var a=0;a<e&&e==r;a++)t[a]=t[a+1];e==r?t[e-1]=n:t[e]=n}(L,T,t,n),n<++T&&(T=n),0==e&&N(L,n,250,e),250==E&&(n=N(L,n,250,e),console.log("当前心率"+n),n&&null!=n&&0<n&&9<e&&(A=n),E=0),E++,A},MedLvbo:function(t,e){var n,r,a,i=[],o=0,s=!0;0!=t&&(this.mFirstSize=t,n=new w(t)),0!=e&&(this.mSecondSize=e,r=new I(e)),i=[a=t+e>>1],this.init=function(t){var e=t;if(null!=n&&(n.init(e),e=n.getValue(0)),null!=r&&(r.init(e),e=r.getValue(0)),s){s=!1;for(var c=0;c<a;c++)i[c]=t}var l=i[o];return l-=e,i[o]=t,a<=++o&&(o=0),l}},smooth:function(){for(var t=128,e=[t],n=0;n<t;n++)e[0]=0;for(var r=[t],a=0;a<t;a++)r[0]=0;for(var i=[t],o=0;o<t;o++)i[0]=0;for(var s=[t],c=0;c<t;c++)s[0]=0;for(var l=[t],u=0;u<t;u++)l[0]=0;for(var h=[t],d=0;d<t;d++)h[0]=0;var g=0,f=112,v=64,p=new D,m=new D,b=0;function y(){return(8*s[v]+s[w(-1)]+s[w(1)]+s[w(-2)]+s[w(2)])/12}function x(t){return((t=t<0?30+t:t)*y()+(30-t)*i[v])/30}function w(e){return v+e+t&127}this.init=function(n){return n=function(n){var a=p.init(n),i=p.v(),o=i-a,c=Math.abs(o);n=function(t){if(I[B]=t,L[B])t<A&&(L[B]=!1,L[S]=!0,S=B,M(t));else if(A<t){L[B]=!0,A=t,S=B;for(var e=0;e<256;e++){var n=I[e];1==L[e]&&n<A&&(S=e,A=n)}L[S]=!1}else B==S&&A!=t&&M(t);return 256==++B&&(B=0),A}(c);return s[g]=o,h[g]=n,r[g]=a,e[g]=i,l[g]=c,++g==t&&(g=0),o}(n),n=m.init(n),i[f]=n,++f==t&&(f=0),++v==t&&(v=0),h[v]<l[v]?(b=30,y()+r[v]):0!=b?(b<0?b++:b--,x(b)+r[v]):h[w(30)]<l[w(30)]?(b=-30,x(0)+r[v]):r[v]+i[v]};for(var I=[256],C=0;C<256;C++)I[C]=0;for(var S=10,L=[256],T=0;T<10;T++)L[T]=!0;for(var E=10;E<256;E++)L[E]=!1;var A=0,B=0;function M(t){A=t;for(var e=0;e<256;e++){var n=I[e];0==L[e]&&A<n&&(S=e,A=n)}}},SmoothLvbo:function(){var t=new C,e=new S;this.init=function(n){var r=t.init(n);n=t.getValue();return e.init(n,r)}},getRandomArrayElements:function(t,e){return 40<=t.length?_(function(t,e){for(var n,r,a=t.slice(0),i=t.length,o=i-40;i-- >o;)n=a[r=Math.floor((i+1)*Math.random())],a[r]=a[i],a[i]=n;return a.slice(o)}(t),e):0<t.length&&t.length<40?_(t,e):void 0},arrayToJson:function e(n){var r=[];if("string"==typeof n)return'"'+n.replace(/([\'\"\\])/g,"\\$1").replace(/(\n)/g,"\\n").replace(/(\r)/g,"\\r").replace(/(\t)/g,"\\t")+'"';if("object"!=t(n))return n.toString();if(n.sort){for(a=0;a<n.length;a++)null!==n[a]&&void 0!==n[a]&&"null"!==n[a]&&r.push(a+":"+e(n[a]));r="["+r.join()+"]"}else{for(var a in n)r.push(a+":"+e(n[a]));document.all&&!/^\n?function\s*toString\(\)\s*\{\n?\s*\[native code\]\n?\s*\}\n?\s*$/.test(n.toString)&&r.push("toString:"+n.toString.toString()),r="{"+r.join()+"}"}return r},str2ab:function(t){for(var e=t.length/2,n=new ArrayBuffer(e),r=new DataView(n),a=0;a<e;a++){var i="0x"+t.slice(2*a,2*a+2);r.setUint8(a,i)}return n},comBat:function(t){if("5b21"==t.substr(0,4))return{notEcg:parseInt(t.substr(10,2)+t.substr(8,2).toString(),16),ecg:parseInt(t.substr(6,2)+t.substr(4,2).toString(),16)};console.error("1004")},toDrawData:function(t){return t&&0!=t.length?function(t){for(var e=t.length/2,n=[],r=0;r<e;r++)n[r]=function(t){return 32767.5<t&&(t|=-65536),t}(parseInt("0x"+t[2*r+1]+t[2*r]));return n}(function(t){for(var e=[],n=t.length>>1;0<=--n;)e[n]=t.substr(2*n,2);return e}(t)):[]},toEcgT3:function(t){try{var e=function(t){return t?(t=t.split(" ")[0].split("-"),new Date(t[0],t[1]-1,t[2])):new Date}(function(t){return null==t?"":(t=new Date(t)).getFullYear()+"-"+(t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1)+"-"+(t.getDate()<10?"0"+t.getDate():t.getDate())+" "+(t.getHours()<10?"0"+t.getHours():t.getHours())+":"+(t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes())+":"+(t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds())}((new Date).getTime()));if(!t)return;var n=t.split(",");if(0==n.length)return;for(var r=n.length,a=parseInt(r/250),i=new ArrayBuffer(20+521*a),o=new DataView(i),s=(b=o,y=e,(x=new ArrayBuffer(4))[0]=1,x[1]=0,x[2]=0,x[3]=0,function(t,e,n){for(var r=0;r<n.byteLength;r++)t.setInt8(0+r,n[r])}(b,0,x),H(b,4,1),function(t,e,n){var r=function(t){return(t.getFullYear()+"").substr(2,2)}(n);t.setInt8(5,r),r=n.getMonth()+1,t.setInt8(6,r),r=n.getDate(),t.setInt8(7,r),r=n.getHours(),t.setInt8(8,r),r=n.getMinutes()+1,t.setInt8(9,r),n=n.getSeconds(),t.setInt8(10,n)}(b,0,y),Q(b,11,0),Q(b,15,0),H(b,19,0),20),c=0,l="",u=0,h=0;h<a;h++){Q(p=o,m=s,c),H(p,m+4,0),H(p,m+5,0),V(p,m+6,0),V(p,m+8,0),H(p,m+10,0),V(p,m+11,0),V(p,m+13,0),V(p,m+15,0),Q(p,m+17,0);for(var d=s+21,g=250*h;g<250*(h+1);g++){var f,v=parseInt(Number(n[g]));u<625&&(0==(f=(parseInt(v,10)>>>0).toString(16)).length?f="0000":1==f.length?f="000"+f:2==f.length?f="00"+f:3==f.length&&(f="0"+f),l+=f=f.substr(f.length-2,2)+f.substr(f.length-4,2),u++),o.setInt16(d,v,!0),d+=2}s+=521,c+=1}return{length:a,buffer:i,buf25:l}}catch(t){return}var p,m,b,y,x},continueCommand:function(t){var e=j([t]);t=P("21".concat(e,"0c0004"));return"5b21".concat(e,"0c0004").concat(t,"5d")},EquipmentElectric:function(t){if(""==t)console.error("1001");else{if("5b22"==t.substr(0,4))return 100<=(t=parseInt(t.substr(18,2).toString(),16))?100:t;console.error("1004")}},DeviceId:function(t){if(""==t)console.error("1001");else{if("5b52"==t.substr(0,4))return function(t){var e=t.trim();e=e.substr(18,30);for(var n="",r=0;r<e.length;r+=2){var a=e.substr(r,2);a=parseInt(a.toString(),16);n+=a=String.fromCharCode(a)}return n}(t);console.error("1004")}},BluetoothChannel:function(t){if(0===t)return{SERVICE_ID:"01ff0100-ba5e-f4ee-5ca1-eb1e5e4b1ce1",CHARACTERISTIC_ID:"01ff0101-ba5e-f4ee-5ca1-eb1e5e4b1ce1"};console.error("1002")},Upgrade:function(t,e){!function(t,e){if(t&&e){var n=new XMLHttpRequest;n.open("get",t,!0),n.responseType="blob",n.onload=function(){e(200==this.status&&this.response)},n.send()}}(t,(function(t){if(!t)return!1;var n=new FileReader;n.readAsArrayBuffer(t),n.onload=function(){e(function(t){var e=new Uint8Array(t);window._lengthUoGrade=e.byteLength;for(var n=e.byteLength/128,r=new Array,a=0,i=0;i<n;i++)r[a]=e.slice(128*i,128*(i+1)),a++;return function(t){for(var e=[],n=0;n<t.length;n++)e.push({id:n,seq:G(n.toString(16),8),data:F(t[n]),state:"00",lens:function(t,e,n,r){return t=n===r.length-1?(12+(r=F(r[r.length-1]).length/2)).toString(16):140..toString(16),String(t).length,(Array(4).join("0")+t+Array(3).join("0")).slice(-4)}(1,0,n,t)});return function(t){for(var e=0;e<t.length;e++){var n=P("27".concat(t[e].seq).concat(t[e].lens,"00").concat(t[e].data));t[e].CRC=n,t[e].command="5b27".concat(t[e].seq).concat(t[e].lens,"00").concat(t[e].data).concat(n,"5d")}var r=function(){var t=parseInt(window._lengthUoGrade/128),e=window._lengthUoGrade%128==0?t:t+1,n=G(window._lengthUoGrade.toString(16),8),r=G(e.toString(16),8);t=P("27".concat(n,"0c0000")),e=P("28".concat(r,"0c0000"));return{startCommand:t="5b27".concat(n,"0c0000").concat(t,"5d"),endCommand:e="5b28".concat(r,"0c0000").concat(e,"5d")}}();return{totalArr:t,upGradecommand:r}}(e)}(r)}(this.result))}}))},staticCommand:function(t){var e=G((t+3).toString(16),8);e=P(t="21".concat(e,"0c0000"));return"5b".concat(t).concat(e,"5d")},format:function(t){var e=10<=Math.floor(t/3600)?Math.floor(t/3600):"0"+Math.floor(t/3600);t-=3600*e;var n=10<=Math.floor(t/60)?Math.floor(t/60):"0"+Math.floor(t/60);return e+":"+n+":"+(10<=(t-=60*n)?t:"0"+t)}};var z={url:"",canTimer:null,measureMode:0,valueArr:[],Voltagevalue:!1,valueNum:0,status:0,measureTimeLength:0,valueHandleOne:!0,getEcgNameUpload:"",deviceSN:"",deviceId:"",serviceId:"",count:0,path:"https://api-test.995120.cn",baseUrl:"http://api-dev.995120.cn",uuid:"e1d495e7beb311ebbfc79e874d1faa1d",reportNo:"",Authorization:"",SERVICE_ID:"",CHARACTERISTIC_ID:"",ecgData:null,ecgTimer:null,dataarr:[],dataarridx:0,currwidth:0,mb:null,crc:null,cmd:null,msgLength:null,bat:null,seq:null,temp:null,length:null,index:null,scaling:2e3,medLvbo:null,smoothLvbo:null,arrayQueue:null,arrayQueue10sec:null,arrayQueue10secidx:0,arrayQueue10secidxhr:0,insHeartRate:70,onesec:0,onelen:0};function Y(t){this.canvasgrid=t.canvasgrid||"canvasgrid",this.canvasman=t.canvasman||"canvasman",this.smallGridlineWidth=parseInt(t.smallGridlineWidth)||.3,this.smallGrideLineColor=t.smallGrideLineColor||"#333",this.BigGridlineWidth=parseInt(t.BigGridlineWidth)||.4,this.BigGrideLineColor=t.BigGrideLineColor||"#444",this.ecgLineWidth=parseInt(t.ecgLineWidth)||1,this.ecgLineColor=t.ecgLineColor||"#32CD32",this.devices=[],this.connected=!1,this.chs=[],this.insHeartRate=0,this.deviceId="",this.deviceSN="",this.electricity=0,this.electricityindex=0,this.ecgCanvas=!0,this.time="",this.fallContent="",this._discoveryStarted=!1,this.BlueConnected=!1,this.OpenPhoneBlue=!1,this.Status="",this.version="",this.connectErrorCallback=null,this.ecgTimer=null,this.init()}Y.prototype.init=function(){this.switch()},Y.prototype.onLoad=function(){var t=(e=U.BluetoothChannel(0)).SERVICE_ID,e=e.CHARACTERISTIC_ID;z.SERVICE_ID=t,z.CHARACTERISTIC_ID=e,z.dataarr=[],z.count=0,z.dataarridx=0,clearInterval(z.ecgTimer),this.devices=[]},Y.prototype.onReady=function(){var t=0,e=0;wx.getSystemInfo({success:function(n){t=n.windowWidth-4,e=n.windowHeight-200}}),this.canvasWidth=t,this.canvasHeight=e,z.currwidth=t,this.position={x:150,y:10,vx:2,vy:2},this.x=-100,this.drawGrid(this.canvasgrid),this.drawMan(this.canvasman),z.medLvbo=new U.MedLvbo(100,25),z.smoothLvbo=new U.SmoothLvbo,z.arrayQueue=new U.ArrayQueue,setInterval((function(){if(null!=z.arrayQueue&&0<z.arrayQueue.size()){for(var t=void 0,e=0;e<20;e++){var n=z.arrayQueue.pop();if(null==n)break;z.dataarr[n.idx]=n,t=n}if(null!=t)for(var r=t.idx+1;r<t.idx+5;r++){var a={y:0};a.idx=r,z.dataarr[r]=a}}}),80),this.ecgCanvas=!1},Y.prototype.switch=function(){this.onLoad(),this.onReady()},Y.prototype.drawCanvas=function(){this.drawGrid(this.canvasgrid),this.drawMan(this.canvasman)},Y.prototype.searchDevices=function(t){z.valueHandleOne=!0,z.valueNum=0,z.valueArr=[],this.StartBluetoothDevicesDiscovery(t),this.onBluetoothAdapterStateChange()},Y.prototype.initBluetooth=function(t,e){var n=this;wx.openBluetoothAdapter({success:function(r){n.OpenPhoneBlue=!0,n.connectErrorCallback=e,n.onBluetoothAdapterStateChange(),-1!=r.errMsg.indexOf("ok")&&t({errCode:0})},fail:function(t){n.OpenPhoneBlue=!1,n.connectErrorCallback=e,n.onBluetoothAdapterStateChange(t),e(t)}})},Y.prototype.onBluetoothAdapterStateChange=function(t){var e=this;wx.onBluetoothAdapterStateChange((function(n){e.BlueConnected=n.available,0==n.available&&(t?e.connectErrorCallback(t):e.connectErrorCallback({errCode:2,errMsg:"Bluetooth not connect"}),setTimeout((function(){clearInterval(z.ecgTimer),z.canvasFlag=!0,e.ecgCanvas=!1,z.count=0}),1e3))}))},Y.prototype.StartBluetoothDevicesDiscovery=function(t){var e=this;this._discoveryStarted||(this._discoveryStarted=!0,wx.startBluetoothDevicesDiscovery({allowDuplicatesKey:!0,success:function(n){e.OnBluetoothDeviceFound(t)},fail:function(e){t(e)}}))},Y.prototype.stopBluetoothDevicesDiscovery=function(){wx.stopBluetoothDevicesDiscovery()},Y.prototype.OnBluetoothDeviceFound=function(t){var e=this;wx.onBluetoothDeviceFound((function(n){var r;n.devices.forEach((function(t){var n="",r="";t.name&&(n=t.name.substring(0,1),r=t.name.substring(0,3)),!t.name&&!t.localName||"T"!=n&&"HLW"!=r||e.devices.push(t)})),0<e.devices.length?(n=e.devices,r={},n=n.reduce((function(t,e){return r[e.name]||(r[e.name]=t.push(e)),t}),[]),t({status:0,devices:n})):t({status:2,devices:e.devices})}))},Y.prototype.startMeasure=function(t,e){z.valueHandleOne=!0,z.valueNum=0,z.measureMode=t.type,z.measureTimeLength=t.length,z.deviceId=t.deviceId,z.url=t.url||"",z.continue=t.continue||0,t=z.deviceId,this.createBLEConnection(t,e)},Y.prototype.addTime=function(t){wx.request({url:"".concat(z.url,"/iot/data/saveTime"),method:"POST",header:{"content-type":"application/json"},data:{deviceSn:t},success:function(t){var e,n;console.log("添加开始时间--数据库",t.data),console.log("添加开始时间--数据库--打印",null==t||null===(e=t.data)||void 0===e||null===(n=e.respHead)||void 0===n?void 0:n.respCode)},fail:function(t){console.log("添加开始时间报错",t)}})},Y.prototype.clearDataBase=function(t){var e=this;wx.request({url:"".concat(z.url,"/iot/data/deldata"),method:"POST",header:{"content-type":"application/json"},data:{deviceSn:t},success:function(n){e.addTime(t),console.log("删除24小时历史上传数据",n.data)},fail:function(t){console.log("删除24小时历史上传数据",t)}})},Y.prototype.createBLEConnection=function(t,e){var n=this;wx.createBLEConnection({deviceId:t,success:function(r){n.connected=!0,n.ecgCanvas=!0,n.deviceId=t,n.insHeartRate=0,n.drawCanvas(),n.getBLEDeviceServices(t,e)},fail:function(r){console.log("wx-createBLEConnection-err",r),-1==r.errCode&&n.getBLEDeviceServices(t,e),e(r)}}),this.stopBluetoothDevicesDiscovery()},Y.prototype.closeBLEConnection=function(){wx.closeBLEConnection({deviceId:this.deviceId}),this.connected=!1,this.chs=[],this.canWrite=!1,this.insHeartRate=0},Y.prototype.getBLEDeviceServices=function(t,e){var n=this;wx.getBLEDeviceServices({deviceId:t,success:function(r){console.log(" res.services.length",r.services.length);for(var a=0;a<r.services.length;a++)!function(a){r.services[a].isPrimary&&setTimeout((function(){n.getBLEDeviceCharacteristics(t,r.services[a].uuid,e)}),500)}(a)}})},Y.prototype.getBLEDeviceCharacteristics=function(t,e,n){var r=this;z.SERVICE_ID=e;var a=this;wx.getBLEDeviceCharacteristics({deviceId:t,serviceId:e,success:function(n){r.blSuccess=!0;for(var i=0;i<n.characteristics.length;i++){var o,s=n.characteristics[i];z.CHARACTERISTIC_ID=s.uuid,s.properties.read&&wx.readBLECharacteristicValue({deviceId:t,serviceId:e,characteristicId:s.uuid}),s.properties.write&&(r.canWrite=!0,o=s.uuid.toUpperCase(),setTimeout((function(){a.submitCommands(2,t,e,o),0==z.measureMode?a.submitCommands(-1,t,e,o):1==z.measureMode&&0==z.continue?a.submitCommands(5,t,e,o):2==z.measureMode&&0==z.continue&&a.submitCommands(1,t,e,o)}),500)),(s.properties.notify||s.properties.indicate)&&wx.notifyBLECharacteristicValueChange({deviceId:t,serviceId:e,characteristicId:s.uuid,state:!0})}},fail:function(t){a.blSuccess=!0}}),wx.onBLECharacteristicValueChange((function(t){console.log('222222',t);null==z.dataarr&&(z.dataarr=[]);var e,i=U.ab2hex(t.value);if("5b52"==i.substr(0,4)?(console.log("5b52=========="),e=U.DeviceId(i),(1==z.measureMode&&0==z.continue||2==z.measureMode&&0==z.continue)&&r.clearDataBase(e),z.deviceSN=e,r.deviceSN=e):"5b22"==i.substr(0,4)&&(r.electricity=U.EquipmentElectric(i)),"5b23"==i.substr(0,4)){for(var o=i.substr(i.length-14,8),s="",c=0;c<o.length/2;c++)s+=o.slice(2*c,2*(c+1))==o.substr(o.length-2,2)?parseInt(o.slice(2*c,2*(c+1)).toString(),16):parseInt(o.slice(2*c,2*(c+1)).toString(),16)+".";r.version=s}U.EcgInteractive(U.ab2hex(t.value),(function(t){switch(1==t.fallContent?z.Voltagevalue=!0:z.Voltagevalue=!1,r.fallContent=t.fallContent,t.cmd){case 34:!function(t){z.count++;for(var e,r=(t=t.param).byteLength,i=11;i<r&&!(r<i+2);i+=2){755<z.dataarridx&&(z.dataarridx=0);var o={},s=z.dataarridx++,c=(c=s*z.currwidth/750).toFixed(2),l=50*(l=t.getInt16(i,!0))/z.scaling,u=l=z.medLvbo.init(l);l*=1e3,l=z.smoothLvbo.init(l),l/=1e3,Math.ceil(100*l/z.scaling),0==z.measureMode?(z.status=0,z.Voltagevalue?z.valueArr.push(32767):z.valueArr.push(u),z.valueNum++,z.valueHandleOne&&z.valueNum==250*z.measureTimeLength&&(z.valueHandleOne=!1,z.status=1,a.closeBLEConnection(),clearInterval(z.ecgTimer),z.count=0)):1==z.measureMode||z.measureMode,function(t){70!=(t=U.qrs_det(t,z.arrayQueue10secidx))&&(z.insHeartRate=Math.floor(t)),z.arrayQueue10secidx++,7500==z.arrayQueue10secidx&&(z.arrayQueue10secidx=0)}(l),l=(l=100-l).toFixed(2),o.x=c,o.y=l,o.idx=s,z.arrayQueue.push(o)}0==z.measureMode?(e=U.toEcgT3(z.valueArr.toString()),n({status:z.status,valueData:e.buffer})):1!=z.measureMode&&2!=z.measureMode||n({})}(t);break;case 35:var e=t.param;z.scaling=e.getInt16(2,!0)}})),z.arrayQueue10secidx%1e3==0&&(r.insHeartRate=Number(z.insHeartRate))}))},Y.prototype.submitCommands=function(t,e,n,r){var a,i="";0==z.measureMode&&-1==t&&(i=U.staticCommand(z.measureTimeLength),a=U.str2ab(i)),-1!=t&&(i=U.IssueaAnOrder(t).command,a=U.str2ab(i)),this.deviceId=z.deviceId;var o="";wx.writeBLECharacteristicValue({deviceId:e,serviceId:n,characteristicId:r,value:a,success:function(e){0==t?o="快速测量模式":1==t?o="睡眠模式":2==t?o="获取设备SN号":3==t?o="停止模式":4==t?o="上传历史数据":5==t?o="24小时监测模式":6==t?o="清除历史数据":-1==t&&(o="静态测量时长自定义"),console.log("writeBLECharacteristicValue success======="+o,e.errMsg)},complete:function(t){console.log("下面命令回调--"+o,t)}})},Y.prototype.closeBluetoothAdapter=function(){wx.closeBluetoothAdapter(),this._discoveryStarted=!1},Y.prototype.rungrid=function(t,e,n){var r=this.ctx3,a=n/40,i=e/80;r.lineWidth=this.smallGridlineWidth,r.strokeStyle=this.smallGrideLineColor,r.beginPath();for(var o=0;o<=280;o++){var s=o*i;r.moveTo(s,0),r.lineTo(s,n)}for(var c=0;c<=280;c++){var l=c*a;r.moveTo(0,l),r.lineTo(e,l)}for(r.stroke(),r.lineWidth=this.BigGridlineWidth,r.strokeStyle=this.BigGrideLineColor,r.beginPath(),o=0;o<=280;o+=5)s=o*i,r.moveTo(s,0),r.lineTo(s,n);for(c=0;c<=280;c+=5)l=c*a,r.moveTo(0,l),r.lineTo(e,l);r.stroke(),r.beginPath(),r.draw()},Y.prototype.drawGrid=function(t){var e=this;wx.createSelectorQuery().select("#"+t).context((function(t){e.ctx3=t.context})).exec(),wx.createSelectorQuery().select("#"+t).boundingClientRect(function(t){e.rungrid(100,t.width,t.height)}.bind(e)).exec()},Y.prototype.runMan=function(t,e,n,r){var a=this,i=a.ctxq;function o(){if(z.dataarr&&0<z.dataarr.length){var t=z.dataarr;i.lineWidth=a.ecgLineWidth,i.strokeStyle=a.ecgLineColor,i.beginPath();var e=!0;i.moveTo(0,0);for(var n=0;n<t.length;n++){var r=t[n];null!=r&&null!=r.y&&(0==r.y?e=!0:0!=r.y&&(e&&(i.moveTo(r.x,r.y),e=!1),i.lineTo(r.x,r.y)))}i.stroke(),i.beginPath(),i.draw()}}i.clearRect(0,0,e,n),clearInterval(a.ecgTimer),0!=r?a.ecgTimer=setInterval(o,10):o()},Y.prototype.drawMan=function(t,e){var n=this;wx.createSelectorQuery().select("#"+t).context((function(t){n.ctxq=t.context})).exec(),wx.createSelectorQuery().select("#"+t).boundingClientRect(function(t){var r=parseInt(t.width/2),a=parseInt(t.height/2);n.ctxq.clearRect(0,0,r,a),n.runMan(100,t.width,t.height,e)}.bind(n)).exec()};var $=Y,X={dataarr:[]};function J(t){this.canvasgrid=t.canvasgrid||"canvasgrid",this.canvasman=t.canvasman||"canvasman",this.smallGridlineWidth=parseInt(t.smallGridlineWidth)||.3,this.smallGrideLineColor=t.smallGrideLineColor||"#333",this.BigGridlineWidth=parseInt(t.BigGridlineWidth)||.4,this.BigGrideLineColor=t.BigGrideLineColor||"#444",this.ecgLineWidth=parseInt(t.ecgLineWidth)||1,this.ecgLineColor=t.ecgLineColor||"#32CD32",this.height=t.height||165,this.width=t.width||375,this.dataIdx=0,this.dataArrIdx=0}J.prototype.switch=function(){this.drawGrid(this.canvasgrid),this.drawMan(this.canvasman)},J.prototype.drawGrid=function(t,e){e=wx.createCanvasContext("canvasgrid",e),this.ctx2=e,this.rungrid(100,this.width,this.height)},J.prototype.drawMan=function(t,e){var n=this;e=wx.createCanvasContext(t,e);this.ctxman=e,setTimeout((function(){n.runMan()}),1e3)},J.prototype.rungrid=function(t,e,n){var r=this.ctx2,a=n/40,i=e/80;r.lineWidth=this.smallGridlineWidth,r.strokeStyle=this.smallGrideLineColor,r.beginPath();for(var o=0;o<=280;o++){var s=o*i;r.moveTo(s,0),r.lineTo(s,n)}for(var c=0;c<=280;c++){var l=c*a;r.moveTo(0,l),r.lineTo(e,l)}for(r.stroke(),r.lineWidth=this.BigGridlineWidth,r.strokeStyle=this.BigGrideLineColor,r.beginPath(),o=0;o<=280;o+=5)s=o*i,r.moveTo(s,0),r.lineTo(s,n);for(c=0;c<=280;c+=5)l=c*a,r.moveTo(0,l),r.lineTo(e,l);r.stroke(),r.beginPath(),r.draw()},J.prototype.drawEcg=function(t,e){this.drawGrid(this.canvasgrid,e),this.drawMan(this.canvasman,e),t=U.toDrawData(t),this.getArrData(t)},J.prototype.getArrData=function(t){try{for(var e=20*this.dataIdx,n=0;n<625;n++){var r=t[e+n],a={},i=this.dataArrIdx++,o=i*this.width/625,s=Math.floor(.6*this.height)-50*r/126;a.x=o,a.y=s,a.idx=i,X.dataarr[i]=a}this.dataIdx++}catch(t){return}},J.prototype.runMan=function(){var t=this,e=t.ctxman;!function(){if(X.dataarr&&0<X.dataarr.length){var n=X.dataarr;e.lineWidth=t.ecgLineWidth,e.strokeStyle=t.ecgLineColor,e.beginPath();var r=!0;e.moveTo(0,0);for(var a=0;a<n.length;a++){var i=n[a];null!=i&&null!=i.y&&(0==i.y?r=!0:0!=i.y&&(r&&(e.moveTo(i.x,i.y),r=!1),e.lineTo(i.x,i.y)))}e.stroke(),e.beginPath(),e.draw()}}()};var K=J;var Z={canvasgrid:"",canvasman:"",smallGridlineWidth:"",smallGrideLineColor:"",BigGridlineWidth:"",BigGrideLineColor:"",ecgLineWidth:"",ecgLineColor:"",ctx:"",ctxq:"",dataarr:[],dataArr:[],dataIdx:0,canvasWH:{width:""},dataArrIdx:0,arrList:[],toDrawData:"",ecgRates:"",filtering:""};function tt(){return Z.ctxq=Z.canvasman.getContext("2d"),function(){if(Z.ctxq.stroke(),Z.dataarr&&0<Z.dataarr.length){var t=Z.dataarr;Z.ctxq.lineWidth=Z.ecgLineWidth,Z.ctxq.strokeStyle=Z.ecgLineColor,Z.ctxq.beginPath();var e=!0;Z.ctxq.moveTo(0,0);for(var n=0;n<Z.dataarr.length;n++){var r=t[n];null!=r&&null!=r.y&&(0==r.y?e=!0:0!=r.y&&(e&&(Z.ctxq.moveTo(r.x+.5,r.y+.5),e=!1),Z.ctxq.lineTo(r.x+.5,r.y+.5)))}Z.ctxq.stroke()}}((canvasman.width,canvasman.height))}function et(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function nt(t,e,n,r,a,i,o){try{var s=t[i](o),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(r,a)}function rt(t){return function(){var e=this,n=arguments;return new Promise((function(r,a){var i=t.apply(e,n);function o(t){nt(i,r,a,o,s,"next",t)}function s(t){nt(i,r,a,o,s,"throw",t)}o(void 0)}))}}var at=n(757),it=n.n(at);function ot(e){var n=[];if("string"==typeof e)return'"'+e.replace(/([\'\"\\])/g,"\\$1").replace(/(\n)/g,"\\n").replace(/(\r)/g,"\\r").replace(/(\t)/g,"\\t")+'"';if("object"!=t(e))return e.toString();if(e.sort){for(r=0;r<e.length;r++)null!==e[r]&&void 0!==e[r]&&"null"!==e[r]&&n.push(r+":"+ot(e[r]));n="["+n.join()+"]"}else{for(var r in e)n.push(r+":"+ot(e[r]));/^\n?function\s*toString\(\)\s*\{\n?\s*\[native code\]\n?\s*\}\n?\s*$/.test(e.toString)||n.push("toString:"+e.toString.toString()),n="{"+n.join()+"}"}return n}function st(t){this.fitArr=[],this.lossUploading=!1,this.arrToNum=[],this.lossItem="",this.mSeq="",this.newSeq="",this.leftTime="--=--=--",this.timer=null,this.abort=!0,this.mb=null,this.scaling=1e3,this.MSG_FIX=12,this.sbuf=new DataView(new ArrayBuffer(4)),this.sbufidx=0,this.status=0,this.cmd=null,this.seq=0,this.msgLength=null,this.temp=null,this.length=null,this.index=null,this.bat=null,this.arrayQueue10secidx=0,this.dataarridx=0,this.crc=null,this.currwidth=0,this.medLvbo=null,this.smoothLvbo=null,this.gMap=new Map,this.bMap=new Map,this.idx_b=0,this.idx=0,this.loss=[],this.lossArr=[],this.j=0,this.changeStatus=0,this.identification=!1,this.noEcgArray=[],this.noEcgBatArray=[],this.ecgArray=[],this.ecgBatArray=[],this.times=0,this.notEcg=0,this.ecg=0,this.handleOneNecg=!0,this.handleOnEcg=!0,this.ecgOne=!0,this.reportId="",this.seq_b="",this.seq_j=0,this.ecgLossItemArray=[],this.ecgOverTimes=0,this.ecgUploadOne=!1,this.batLos=!1,this.Packet=-1,this.seqNum=0,this.lossBatBoolean=!1,this.failData=!1,this.lossBatTrue=!1,this.seqNum39=0,this.ecgHandleOne=!0,this.continueTip=!1,this.continueName="",this.deviceUniqueCode="",this.updatatoken="",this.startSynTime="",this.syn50PackageTime="",this.mac="",this.visible=!1,this.meterDurationTimer=null,this.synSpeed="",this.maxFileName="",this.uploadUrl=t.baseUrl+"/iot/file/upload/dynamicecg",this.maxFileNameUrl=t.baseUrl+"/iot/data/status",this.checkLoseUrl=t.baseUrl+"/iot/data/replenish-data",this.deleteUrl=t.baseUrl+"/iot/data/deldata",this.saveuploadingUrl=t.baseUrl+"/iot/data/setUploadingStatus",this.deviceSn=t.deviceSn,this.deviceId=t.deviceId,this.getEcgNameUpload=null,this.getValue=t.getValue,this.success=t.success,this.fail=t.fail,this.localRate=t.rate,this.rate=t.rate,this.SERVICE_ID="",this.CHARACTERISTIC_ID="",this.sucFlag=!1,this.serviceIdCheck=!1,this.loubaoChecking=!1,this.getMaxFileName();var e=this;wx.getSystemInfo({success:function(t){e.platform=t.platform}})}st.prototype.bleInit=function(){var t=this,e=this.deviceId;console.log("deviceId...",e),wx.openBluetoothAdapter({success:function(n){t.createLink(e),t.onBluetoothAdapterStateChange()},fail:function(t){t.errCode}})},st.prototype.createLink=function(t){var e=this;wx.createBLEConnection({deviceId:t,success:function(n){console.log("res===0123",n),e.getBLEDeviceServices(t)},fail:function(n){-1==n.errCode&&e.getBLEDeviceServices(t)}})},st.prototype.onBluetoothAdapterStateChange=function(){var t=this;wx.onBluetoothAdapterStateChange((function(e){0==e.available&&t.fail({errorCode:2,errMsg:"Bluetooth not connect"})}))},st.prototype.getBLEDeviceServices=function(t){var e=this;console.log("987",t),wx.getBLEDeviceServices({deviceId:t,success:function(n){console.log("getBLEDeviceServices",n);for(var r=0;r<n.services.length;r++)if(n.services[r].isPrimary&&(e.getBLEDeviceCharacteristics(t,n.services[r].uuid),e.serviceIdCheck))return},fail:function(t){console.log("2324res===error",t)},complete:function(t){console.log("12324res===error",t)}})},st.prototype.getBLEDeviceCharacteristics=function(t,e){var n=this,r=this;this.SERVICE_ID=e;var a=this.deviceId;this.deviceSn,wx.getBLEDeviceCharacteristics({deviceId:a,serviceId:e,success:function(t){for(var i=0;i<t.characteristics.length;i++)!function(i){var o=(i=t.characteristics[i]).uuid;r.CHARACTERISTIC_ID=o,i.properties.write&&setTimeout((function(){""==n.maxFileName?n.submitCommands(4,e,o):-1<n.maxFileName.indexOf("ecg")?(n.submitCommands(4,e,o),n.loubaoChecking||(console.log("启动断点续传,maxfileName为 ecg1，当前已经进入漏包查询阶段"),n.getLostArr("ecgData").then((function(t){var e,r=null==t||null===(e=t.data)||void 0===e||null===(r=e.body)||void 0===r?void 0:r.data;console.log("漏包数组====",null==t||null===(a=t.data)||void 0===a?void 0:a.body);var a=[];"string"==typeof r&&r.constructor==String?0<r.length&&(a=r.split(",").map(Number)):Array.isArray(r)&&(a=r.map(Number)),0<a.length&&n.submitPath(a),n.lossArr=a,n.loss=a})))):(n.continueName=Number(n.maxFileName)+7500,console.log("启动断点续传",n.continueName),n.submitCommands(7,e,o),n.continueTip=!0)}),2e3),i.properties.read&&wx.readBLECharacteristicValue({deviceId:a,serviceId:e,characteristicId:i.uuid}),(i.properties.notify||i.properties.indicate)&&wx.notifyBLECharacteristicValueChange({deviceId:a,serviceId:e,characteristicId:i.uuid,state:!0})}(i)},fail:function(t){console.log("getBLEDeviceCharacteristics",t)}}),wx.onBLECharacteristicValueChange((function(t){console.log('333333',t);var e=U.ab2hex(t.value);U.EcgInteractive(e,(function(t){var r,a=n.lossArr;switch(0<a.length&&1==t.state&&(-1!=(r=a.indexOf(t.seq))&&a.splice(r,1),n.lossArr=a),"5b21"==e.substr(0,4)&&(a=(r=U.comBat(e)).notEcg,r=r.ecg,n.notEcg=a,n.ecg=r,console.log("非心电总包数",a),console.log("心电总包数",r),""!=n.maxFileName&&-1==n.maxFileName.indexOf("ecg")&&(n.times=Number(n.maxFileName)+7500+a)),t.cmd){case 33:case 34:case 0:break;case 35:var i=t.param;n.scaling=i.getInt16(2,!0);break;case 36:console.log("进入0X24==========="),t.state;break;case 38:1==t.state&&n.ecgOne&&(console.log("心电数据-初始化"),n.mSeq=t.seq,n.idx=0,""==n.maxFileName&&(n.loss=[]),n.gMap.set(0,new Array(7500))),1==t.state&&(n.ecgOne=!1),n.staircase(t)}}))}))},st.prototype.upload=function(t,e,n,r){var a=this;console.log("调用上传数据接口了",e,n);var i=0==e?"noEcgData":"ecgData",o=(this.reportId,this.str2ab(t)),s={length:t.length,buffer:o};e=this.deviceSn;console.log("binary",JSON.stringify(s)),t=this.uploadUrl,r&&(this.lossUploading=!0),-1==n.indexOf("ecg")&&-1<this.maxFileName.indexOf("ecg")||wx&&(o={url:"".concat(t,"?deviceSn=").concat(e,"&ecgFlag=").concat(i,"&ecgPackageNum=").concat(this.ecg,"&fileName=").concat(n,"&noEcgPackageNum=").concat(this.notEcg),data:s.buffer},console.log("上传接口传递参数",o),wx.request({url:"".concat(t,"?deviceSn=").concat(e,"&ecgFlag=").concat(i,"&ecgPackageNum=").concat(this.ecg,"&fileName=").concat(n,"&noEcgPackageNum=").concat(this.notEcg),method:"POST",header:{},data:s.buffer,success:function(t){console.log("上传数据返回结果=res",t),"000"==t.data.respHead.respCode?(t=t.data.body.data,console.log("上传数据返回结果",t),t&&(r&&(a.lossUploading=!1),a.getEcgNameUpload=t,"noEcgData"==i||(null!=t&&t.filePath&&-1!=(null==t?void 0:t.filePath.indexOf(".ecg"))?(console.log("拿到ecg文件了====",t),a.success(t),a.sucFlag=!0):(Number(n)+7500>Number(a.ecg)||-1<n.indexOf("ecg"))&&(console.log("补包数组====三方",a.lossArr),0!=a.lossArr.length||a.lossUploading||(console.log("this.lossArr.length"),a.getLostArr("ecgData").then((function(t){var e=null==t||null===(e=t.data)||void 0===e||null===(n=e.body)||void 0===n?void 0:n.data;console.log("漏包数组====",e);var n=[];"string"==typeof e&&e.constructor==String?0<e.length&&(n=e.split(",").map(Number)):Array.isArray(e)&&(n=e.map(Number)),0<n.length&&a.submitPath(n),a.lossArr=n,a.loss=n}))))))):console.log("上传数据返回结果==报错error"),s=null},fail:function(t){console.log(123456),console.log(t)}}))},st.prototype.staircase=function(e){var n,r,a;this.newSeq=Number(e.seq),Number(e.seq)%7500==0&&(console.log("手机数据",Number(e.seq),this.times),this.arrToNum.push(this.times)),this.flagEcg=e.state,this.times++,50==this.times&&(this.syn50PackageTime=(new Date).getTime()),0==this.times&&(this.startSynTime=(new Date).getTime()),this.remaining(),this.notEcg,this.ecg,(1!=e.state&&e.seq%10==0||1==e.state&&e.seq%10==0)&&console.log("补传标识：",this.identification,"-----------state:"+e.state,"流水号:"+(Number(e.seq)+1),"非心电包数:"+this.notEcg,"心电包数:"+this.ecg),0==this.identification?(this.continueTip&&(console.log("启动断点续传时"),this.noEcgArray=[],this.noEcgBatArray=[],this.ecgArray=[],this.ecgBatArray=[],n=Number(this.continueName),this.idx=Math.floor(n/7500),this.gMap.set(this.idx,new Array(7500)),this.continueTip=!1,console.log("this.idx",this.idx)),Number(e.seq)%7500==0&&(this.gMap.set(this.idx,new Array(7500)),console.log("this.idx22222",e.seq,this.idx)),n=e.seq-7500*this.idx,this.gMap.get(this.idx)||(console.log("this.idx3333",e.seq,this.idx),console.log("--------异常"+this.gMap.get(this.idx)+this.idx),this.gMap.set(0,new Array(7500))),this.gMap.get(this.idx)[n]=this.dataviewtostr(e.param),n=7500*(this.idx+1)-1,0<Number(e.seq)&&Number(e.seq)%n==0&&(console.log("this.idx444444",e.seq,this.idx),r=this.setFileName(this.idx,"oldObj"),console.log("存满就上传文件",e.state,r),a=ot(this.gMap.get(this.idx)),this.upload(a.toString(),e.state,r),(0==e.state?this.noEcgArray:this.ecgArray).push(r),this.idx++),(0==e.state&&Number(e.seq)+1==this.notEcg||1==e.state&&Number(e.seq)+1==this.ecg)&&(r=this.setFileName(this.idx,"oldObj"),console.log("不足一份~~存满就上传文件",e.state,r),console.log("不足一份~~存满就上传文件",t(r),String(r).length),a=ot(this.gMap.get(this.idx)),this.upload(a.toString(),e.state,r),(0==e.state?this.noEcgArray:this.ecgArray).push(r))):(console.log("历史补传阶段--心电补包数据",this.failData),1==e.state&&this.resolveLossItem(e))},st.prototype.resolveLossItem=function(t){console.log("this.loss",this.loss);var e,n,r=this.reArr(this.loss);this.loss=r,console.log("计数",this.seqNum39),console.log("进入心电数据补包~赵",this.seqNum,this.loss),this.seq_b=Number(t.seq),console.log("补报回来的流水号",this.seq_b),0==this.seqNum&&this.bMap.set(this.idx_b,new Array(7500)),r=t.seq-7500*this.idx_b,console.log("补包位置",r,this.idx_b),this.bMap.get(this.idx_b)[r]=this.dataviewtostr(t.param),-1!=(t=this.loss.indexOf(this.seq_b))&&this.loss.splice(t,1),7500==this.seqNum&&(e="ecgData".concat(this.seq_j),console.log("补包文件名称",e,this.loss),n=ot(this.bMap.get(this.idx_b)),this.upload(n.toString(),1,e),this.seqNum=0,this.idx_b++,this.seq_j++,this.lossBatTrue=!1),0==this.loss.length&&(this.loubaoChecking=!1,e="ecgData".concat(this.seq_j),console.log("不足一份~补包文件名称",e,this.loss),n=ot(this.bMap.get(this.idx_b)),this.upload(n.toString(),1,e,"lossupload"),this.lossBatTrue=!1,this.idx_b=0,this.seq_j++),39==this.seqNum39&&(console.log("补包数据 》 40且成功补了40包数据"),this.seqNum39=0,this.Supplementorder()),this.seqNum++,this.seqNum39++},st.prototype.Supplementorder=function(){var t=this.reArr(this.loss);console.log("判断是否漏包",t.length),this.submitPath(t)},st.prototype.getlossBatArr=function(){var t=this;return new Promise((function(e,n){wx.request({url:t.checkLoseUrl,method:"POST",header:{"content-type":"application/json"},data:{deviceSn:t.deviceSn},success:function(t){"000"===t.data.respHead.respCode&&(e(t),t.data.body.data),console.log("漏包接口--数据库",t.data)},fail:function(t){console.log("查询包数--报错",t)}})}))},st.prototype.remaining=function(){var t=parseInt((Number(this.notEcg)+Number(this.ecg)-this.times)/30).toFixed(0);this.format(t),(t=(this.times/(Number(this.notEcg)+Number(this.ecg))*100).toFixed(0))!=1/0&&""!=t||(t=0),Number(t)<Number(this.localRate)&&(t=this.localRate),this.rate!=t&&(this.rate=100<=Number(t)?"100":t.toString(),this.getValue({rate:this.rate}))},st.prototype.format=function(t){var e=10<=Math.floor(t/3600)?Math.floor(t/3600):"0"+Math.floor(t/3600);t-=3600*e;var n=10<=Math.floor(t/60)?Math.floor(t/60):"0"+Math.floor(t/60);t=10<=(t-=60*n)?t:"0"+t;isNaN(e)||isNaN(n)||isNaN(t)?this.leftTime="--:--:--":this.leftTime=e+":"+n+":"+t},st.prototype.setFileName=function(t,e){return"newObj"==e?"ecgData".concat(t):String(7500*t).trim()},st.prototype.str2ab=function(t){for(var e=new ArrayBuffer(t.length),n=new Uint8Array(e),r=0,a=t.length;r<a;r++)n[r]=t.charCodeAt(r);return e},st.prototype.getMaxFileName=rt(it().mark((function t(){var e,n,r;return it().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=this.maxFileNameUrl,n=this.deviceSn,r=this,XMLHttpRequest?ajax("post",e,{deviceSn:n},{success:function(t){res(res)},fail:function(t){rej(t)}}):wx&&(console.log("wx",n),wx.request({url:e,method:"POST",header:{"content-type":"application/json"},data:{deviceSn:n},success:function(t){var e,n,a,i;"000"==(null==t||null===(e=t.data)||void 0===e||null===(n=e.respHead)||void 0===n?void 0:n.respCode)&&(i=null==t||null===(a=t.data)||void 0===a||null===(i=a.body)||void 0===i?void 0:i.data,console.log("查询最大包数--数据库",i),r.maxFileName=null==i.maxFileName?"":i.maxFileName,r.saveuploading(),r.bleInit())},fail:function(t){console.log("查询包数--报错",t)}}));case 2:case"end":return t.stop()}}),t,this)}))),st.prototype.dataviewtostr=function(t){if(t){for(var e=t.byteLength,n="",r=0;r<e;r++)n+=t.getUint8(r)<16?"0"+t.getUint8(r).toString(16):t.getUint8(r).toString(16);return n}return""},st.prototype.submitCommands=function(t,e,n){var r,a=this,i="",o="";[2,3,4,5,6].includes(t)&&(i=U.IssueaAnOrder(t).command),7===t&&(r=Number(a.maxFileName)+7500,i=U.continueCommand(r),console.log("打印command",i)),i=U.str2ab(i),wx.writeBLECharacteristicValue({deviceId:a.deviceId,serviceId:e,characteristicId:n,value:i,success:function(r){2==t?o="获取设备SN号":3==t?o="停止模式":4==t?o="上传历史数据":5==t?o="24小时监测模式":6==t?o="清除历史数据":7==t&&(o="断点续传"),a.SERVICE_ID=e,a.CHARACTERISTIC_ID=n,a.fitArr.push({serviceId:e,characteristicsId:n}),a.serviceIdCheck=!0},complete:function(t){console.log("下面命令回调--"+o,t)}})},st.prototype.getLostArr=rt(it().mark((function t(){var e;return it().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.loubaoChecking=!0,t.next=3,this.getlossBatArr();case 3:return e=t.sent,t.abrupt("return",e);case 5:case"end":return t.stop()}}),t,this)}))),st.prototype.submitPath=function(){var t=rt(it().mark((function t(e){var n,r=this;return it().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("补包数组=====数据源",e),t.next=3,U.getRandomArrayElements(e,1);case 3:n=t.sent,setTimeout((function(){r.patchCommands(n)}),1500);case 5:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),st.prototype.patchCommands=function(t){var e=this,n=this;this.deviceId,console.log("传入的命令===012",t);var r,a,i=U.str2ab(t);console.log("进入补包命令============"),this.identification=!0,console.log("this.platform+++++++++++++",this.platform),"ios"==this.platform?(r=this.SERVICE_ID,a=this.CHARACTERISTIC_ID,setTimeout((function(){console.log("333333333333this.fitArr",e.fitArr),e.fitArr.forEach((function(t){wx.writeBLECharacteristicValue({deviceId:n.deviceId,serviceId:t.serviceId,characteristicId:t.characteristicsId,value:i,success:function(t){console.log("补包writeBLECharacteristicValue success=======补包",t.errMsg)},complete:function(t){console.log("补包命令回调--补包",t)},fail:function(t){console.log("补包命令 err",t)}})}))}),5e3)):"android"==this.platform&&(r="01ff0100-ba5e-f4ee-5ca1-eb1e5e4b1ce1",a="01ff0101-ba5e-f4ee-5ca1-eb1e5e4b1ce1",wx.writeBLECharacteristicValue({deviceId:this.deviceId,serviceId:r,characteristicId:a,value:i,success:function(t){console.log("补包writeBLECharacteristicValue success=======补包",t.errMsg)},complete:function(t){console.log("补包命令回调--补包",t)},fail:function(t){console.log("补包命令 err",t)}})),console.log("补包参数===",{deviceId:this.deviceId,serviceId:r,characteristicId:a,value:i})},st.prototype.saveuploading=function(){wx.request({url:this.saveuploadingUrl,method:"POST",header:{"content-type":"application/json"},data:{deviceSn:this.deviceSn,uploading:1},success:function(t){var e,n;console.log("保存sn号同步中",t),"000"==(null==t||null===(e=t.data)||void 0===e||null===(n=e.respHead)||void 0===n?void 0:n.respCode)&&console.log("保存sn号同步中成功")},fail:function(t){console.log("删除接口报错",t)}})},st.prototype.stopAsyn=function(){var t=this;t.submitCommands(6,t.SERVICE_ID,t.CHARACTERISTIC_ID),console.log(t.deleteUrl,t.deviceSn),wx.request({url:t.deleteUrl,method:"POST",header:{"content-type":"application/json"},data:{deviceSn:t.deviceSn},success:function(t){var e,n;console.log("删除",t),"000"==(null==t||null===(e=t.data)||void 0===e||null===(n=e.respHead)||void 0===n?void 0:n.respCode)&&console.log("删除成功")},fail:function(t){console.log("删除接口报错",t)}})},st.prototype.closeSyn=function(){this.submitCommands(3,this.SERVICE_ID,this.CHARACTERISTIC_ID)},st.prototype.reArr=function(t){return function(t){return function(t){if(Array.isArray(t))return et(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return et(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?et(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(new Set(t))};var ct=st;function lt(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)),r}function ut(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?lt(Object(n),!0).forEach((function(e){var r,a;r=t,e=n[a=e],a in r?Object.defineProperty(r,a,{value:e,enumerable:!0,configurable:!0,writable:!0}):r[a]=e})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):lt(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function ht(){this.devices=[],this.connected=!1,this.chs=[],this.insHeartRate=0,this.deviceId="",this.deviceSN="",this.electricity=0,this.time="",this.electricityindex=0,this.ecgCanvas=!0,this.time="",this.fallContent="",this._discoveryStarted=!1,this.BlueConnected=!1,this.OpenPhoneBlue=!1,this.Status="",this.version="",this.uploadStatus="",this.connectErrorCallback=null,this.flag=!1,this.ecgTimer=null}function dt(t){var e={};return t.reduce((function(t,n){return e[n.name]||(e[n.name]=t.push(n)),t}),[])}wx.globalData={stop:!1,url:"",canTimer:null,measureMode:0,valueArr:[],Voltagevalue:!1,valueNum:0,status:0,measureTimeLength:0,valueHandleOne:!0,getEcgNameUpload:"",deviceSN:"",deviceId:"",serviceId:"",count:0,path:"https://api-test.995120.cn",baseUrl:"http://api-dev.995120.cn",uuid:"e1d495e7beb311ebbfc79e874d1faa1d",reportNo:"",Authorization:"",SERVICE_ID:"",CHARACTERISTIC_ID:"",ecgData:null,ecgTimer:null,dataarr:[],dataarridx:0,currwidth:0,mb:null,crc:null,cmd:null,msgLength:null,bat:null,seq:null,temp:null,length:null,index:null,scaling:2e3,medLvbo:null,smoothLvbo:null,arrayQueue:null,arrayQueue10sec:null,arrayQueue10secidx:0,arrayQueue10secidxhr:0,insHeartRate:70,onesec:0,onelen:0},ht.prototype.init=function(){this.switch()},ht.prototype.checkStatus=function(t,e,n){console.log("查询上传数据状态",{url:"".concat(t,"/iot/data/status"),deviceSn:e}),wx.request({url:"".concat(t,"/iot/data/status"),method:"POST",header:{"content-type":"application/json"},data:{deviceSn:e},success:function(t){var e,r,a,i;console.log("查询上传数据状态",null==t||null===(e=t.data)||void 0===e||null===(r=e.body)||void 0===r?void 0:r.data),"000"==(null==t||null===(a=t.data)||void 0===a||null===(i=a.respHead)||void 0===i?void 0:i.respCode)&&(t=t.data.body.data.takeTime,n(t))},fail:function(t){console.log("查询上传数据状态-err",t)}})},ht.prototype.onLoad=function(){var t=(e=U.BluetoothChannel(0)).SERVICE_ID,e=e.CHARACTERISTIC_ID;wx.globalData.SERVICE_ID=t,wx.globalData.CHARACTERISTIC_ID=e,wx.globalData.dataarr=[],wx.globalData.count=0,wx.globalData.dataarridx=0,clearInterval(wx.globalData.ecgTimer),this.devices=[]},ht.prototype.onReady=function(){var t=0,e=0;wx.getSystemInfo({success:function(n){t=n.windowWidth-4,e=n.windowHeight-200}}),this.canvasWidth=t,this.canvasHeight=e,wx.globalData.currwidth=t,this.position={x:150,y:10,vx:2,vy:2},this.x=-100,this.drawGrid(this.canvasgrid),this.drawMan(this.canvasman),wx.globalData.medLvbo=new U.MedLvbo(150,25),wx.globalData.smoothLvbo=new U.SmoothLvbo,wx.globalData.arrayQueue=new U.ArrayQueue,this.queToArr=setInterval((function(){if(null!=wx.globalData.arrayQueue&&0<wx.globalData.arrayQueue.size()){for(var t=void 0,e=0;e<20;e++){var n=wx.globalData.arrayQueue.pop();if(null==n)break;wx.globalData.dataarr[n.idx]=n,t=n}if(null!=t)for(var r=t.idx+1;r<t.idx+5;r++){var a={y:0};a.idx=r,wx.globalData.dataarr[r]=a}}}),80),this.ecgCanvas=!1},ht.prototype.switch=function(){this.onLoad(),this.onReady()},ht.prototype.drawCanvas=function(){this.drawGrid(this.canvasgrid),this.drawMan(this.canvasman)},ht.prototype.searchDevices=function(t){wx.globalData.valueHandleOne=!0,wx.globalData.valueNum=0,wx.globalData.valueArr=[],this.StartBluetoothDevicesDiscovery(t),this.onBluetoothAdapterStateChange()},ht.prototype.initBluetooth=function(t,e){var n=this;wx.openBluetoothAdapter({success:function(r){n.OpenPhoneBlue=!0,n.connectErrorCallback=e,n.onBluetoothAdapterStateChange(),-1!=r.errMsg.indexOf("ok")&&t({errCode:0})},fail:function(t){n.OpenPhoneBlue=!1,n.connectErrorCallback=e,n.onBluetoothAdapterStateChange(t),e(t)}})},ht.prototype.onBluetoothAdapterStateChange=function(t){var e=this;wx.onBluetoothAdapterStateChange((function(n){e.BlueConnected=n.available,0==n.available&&(t?e.connectErrorCallback(t):e.connectErrorCallback({errCode:2,errMsg:"Bluetooth not connect"}),setTimeout((function(){clearInterval(wx.globalData.ecgTimer),wx.globalData.canvasFlag=!0,e.ecgCanvas=!1,wx.globalData.count=0}),1e3))}))},ht.prototype.StartBluetoothDevicesDiscovery=function(t){var e=this;this._discoveryStarted||wx.startBluetoothDevicesDiscovery({allowDuplicatesKey:!0,success:function(n){e.OnBluetoothDeviceFound(t)},fail:function(e){t(e)}})},ht.prototype.stopBluetoothDevicesDiscovery=function(){wx.stopBluetoothDevicesDiscovery()},ht.prototype.OnBluetoothDeviceFound=function(t){var e=this;wx.onBluetoothDeviceFound((function(n){n.devices.forEach((function(t){var n="",r="";t.name&&(n=t.name.substring(0,1),r=t.name.substring(0,3)),!t.name&&!t.localName||"T"!=n&&"HLW"!=r||e.devices.push(t)})),0<e.devices.length?(n=dt(e.devices),t({status:0,devices:n})):t({status:2,devices:e.devices})}))},ht.prototype.snConnection=function(t,e){wx.openBluetoothAdapter({success:function(n){var r,a,i,o;-1!=n.errMsg.indexOf("ok")&&(r=!1,a=(new Date).getTime(),i=0,o=[],wx.startBluetoothDevicesDiscovery({allowDuplicatesKey:!0,success:function(n){wx.onBluetoothDeviceFound((function(n){i=(new Date).getTime(),n.devices.forEach((function(t){var e="",n="";t.name&&(e=t.name.substring(0,1),n=t.name.substring(0,3)),!t.name&&!t.localName||"T"!=e&&"HLW"!=n||o.push(t)})),0<(o=dt(o)).length&&((n=o.find((function(e){return e.name==t||e.localName==t})))&&!r?(e({deviceId:n.deviceId}),r=!0):12e4<i-a&&!r&&(e({deviceId:""}),r=!0))}))},fail:function(t){e(t)}}))},fail:function(t){e(ut(ut({},t),{},{deviceId:null}))}})},ht.prototype.startMeasure=function(t,e){this.canvasgrid=t.canvasgrid||"canvasgrid",this.canvasman=t.canvasman||"canvasman",this.smallGridlineWidth=parseInt(t.smallGridlineWidth)||.3,console.log(" this.smallGridlineWidth",this.smallGridlineWidth),this.smallGrideLineColor=t.smallGrideLineColor||"#333",this.BigGridlineWidth=parseInt(t.BigGridlineWidth)||.4,this.BigGrideLineColor=t.BigGrideLineColor||"#444",this.ecgLineWidth=parseInt(t.ecgLineWidth)||1,this.ecgLineColor=t.ecgLineColor||"#32CD32",wx.globalData.measureMode=t.type,wx.globalData.measureTimeLength=t.length,wx.globalData.deviceId=t.deviceId,wx.globalData.url=t.url||"",wx.globalData.continue=0,this.start(e),this.init()},ht.prototype.continueMeasure=function(t,e){this.canvasgrid=t.canvasgrid||"canvasgrid",this.canvasman=t.canvasman||"canvasman",this.smallGridlineWidth=parseInt(t.smallGridlineWidth)||.3,this.smallGrideLineColor=t.smallGrideLineColor||"#333",this.BigGridlineWidth=parseInt(t.BigGridlineWidth)||.4,this.BigGrideLineColor=t.BigGrideLineColor||"#444",this.ecgLineWidth=parseInt(t.ecgLineWidth)||1,this.ecgLineColor=t.ecgLineColor||"#32CD32",wx.globalData.measureMode=t.type,wx.globalData.measureTimeLength=t.length,wx.globalData.deviceId=t.deviceId,wx.globalData.url=t.url||"",wx.globalData.continue=1,this.start(e),this.init()},ht.prototype.start=function(t){wx.globalData.valueHandleOne=!0,wx.globalData.valueNum=0;var e=wx.globalData.deviceId;this.createBLEConnection(e,t)},ht.prototype.addTime=function(t){wx.request({url:"".concat(wx.globalData.url,"/iot/data/saveTime"),method:"POST",header:{"content-type":"application/json"},data:{deviceSn:t},success:function(t){var e,n;console.log("添加开始时间--数据库",t.data),console.log("添加开始时间--数据库--打印",null==t||null===(e=t.data)||void 0===e||null===(n=e.respHead)||void 0===n?void 0:n.respCode)},fail:function(t){console.log("添加开始时间报错",t)}})},ht.prototype.clearDataBase=function(t){wx.request({url:"".concat(wx.globalData.url,"/iot/data/deldata"),method:"POST",header:{"content-type":"application/json"},data:{deviceSn:t},success:function(t){console.log("删除24小时历史上传数据",t.data)},fail:function(t){console.log("删除24小时历史上传数据",t)}})},ht.prototype.createBLEConnection=function(t,e){var n=this;wx.globalData.valueHandleOne=!0,wx.globalData.valueNum=0,wx.createBLEConnection({deviceId:t,success:function(r){n.connected=!0,n.ecgCanvas=!0,n.deviceId=t,n.insHeartRate=0,n.drawCanvas(),n.getBLEDeviceServices(t,e)},fail:function(r){console.log("wx-createBLEConnection-err",r),-1==r.errCode&&n.getBLEDeviceServices(t,e),e(r)}}),this.stopBluetoothDevicesDiscovery()},ht.prototype.closeBLEConnection=function(){wx.closeBLEConnection({deviceId:this.deviceId}),this.connected=!1,this.chs=[],this.canWrite=!1,this.insHeartRate=0},ht.prototype.getBLEDeviceServices=function(t,e){var n=this;wx.getBLEDeviceServices({deviceId:t,success:function(r){console.log(" res.services.length",r.services.length);for(var a=0;a<r.services.length;a++)r.services[a].isPrimary&&n.getBLEDeviceCharacteristics(t,r.services[a].uuid,e)}})},ht.prototype.getBLEDeviceCharacteristics=function(t,e,n){var r=this;wx.globalData.SERVICE_ID=e;var a=this;wx.getBLEDeviceCharacteristics({deviceId:t,serviceId:e,success:function(n){r.blSuccess=!0;for(var i=0;i<n.characteristics.length;i++){var o,s=n.characteristics[i];wx.globalData.CHARACTERISTIC_ID=s.uuid,s.properties.read&&wx.readBLECharacteristicValue({deviceId:t,serviceId:e,characteristicId:s.uuid}),s.properties.write&&(r.canWrite=!0,o=s.uuid.toUpperCase(),setTimeout((function(){a.submitCommands(2,t,e,o)}),500),0==a.uploadStatus&&setTimeout((function(){0==wx.globalData.measureMode?a.submitCommands(-1,t,e,o):1==wx.globalData.measureMode&&0==wx.globalData.continue?a.submitCommands(5,t,e,o):2==wx.globalData.measureMode&&0==wx.globalData.continue&&a.submitCommands(1,t,e,o)}),1e3)),(s.properties.notify||s.properties.indicate)&&wx.notifyBLECharacteristicValueChange({deviceId:t,serviceId:e,characteristicId:s.uuid,state:!0})}},fail:function(t){a.blSuccess=!0}}),wx.onBLECharacteristicValueChange((function(t){console.log('11111',t);if(!wx.globalData.stop){null==wx.globalData.dataarr&&(wx.globalData.dataarr=[]);var e,i=U.ab2hex(t.value);console.log(i);if("5b52"==i.substr(0,4)?"T"==(e=U.DeviceId(i)).substr(0,1)&&(console.log("5b52==========",e),(1==wx.globalData.measureMode&&0==wx.globalData.continue||2==wx.globalData.measureMode&&0==wx.globalData.continue)&&r.addTime(e),wx.globalData.deviceSN=e,r.deviceSN=e):"5b22"==i.substr(0,4)&&(r.electricity=U.EquipmentElectric(i)),"5b23"==i.substr(0,4)){for(var o=i.substr(i.length-14,8),s="",c=0;c<o.length/2;c++)s+=o.slice(2*c,2*(c+1))==o.substr(o.length-2,2)?parseInt(o.slice(2*c,2*(c+1)).toString(),16):parseInt(o.slice(2*c,2*(c+1)).toString(),16)+".";r.version=s}U.EcgInteractive(U.ab2hex(t.value),(function(t){if(!wx.globalData.stop)switch(console.log("传递参数====mb",t.cmd,t.state),r.time=U.remaining(t.seq),1==t.fallContent?wx.globalData.Voltagevalue=!0:wx.globalData.Voltagevalue=!1,r.fallContent=t.fallContent,t.cmd){case 34:!function(t){wx.globalData.count++;for(var e,r=(t=t.param).byteLength,i=11;i<r&&!(r<i+2);i+=2){755<wx.globalData.dataarridx&&(wx.globalData.dataarridx=0);var o={},s=wx.globalData.dataarridx++,c=(c=s*wx.globalData.currwidth/750).toFixed(2),l=50*(l=t.getInt16(i,!0))/wx.globalData.scaling,u=l=wx.globalData.medLvbo.init(l);l*=1e3,l=wx.globalData.smoothLvbo.init(l),l/=1e3,Math.ceil(100*l/wx.globalData.scaling),0==wx.globalData.measureMode?(wx.globalData.status=0,wx.globalData.Voltagevalue?wx.globalData.valueArr.push(32767):wx.globalData.valueArr.push(u),wx.globalData.valueNum++,wx.globalData.valueHandleOne&&wx.globalData.valueNum==250*wx.globalData.measureTimeLength&&(wx.globalData.valueHandleOne=!1,wx.globalData.status=1,a.closeBLEConnection(),clearInterval(wx.globalData.ecgTimer),wx.globalData.count=0)):1==wx.globalData.measureMode||wx.globalData.measureMode,function(t){70!=(t=U.qrs_det(t,wx.globalData.arrayQueue10secidx))&&(wx.globalData.insHeartRate=Math.floor(t)),wx.globalData.arrayQueue10secidx++,7500==wx.globalData.arrayQueue10secidx&&(wx.globalData.arrayQueue10secidx=0)}(l),l=(l=100-l).toFixed(2),o.x=c,o.y=l,o.idx=s,wx.globalData.arrayQueue.push(o)}0==wx.globalData.measureMode?(e=U.toEcgT3(wx.globalData.valueArr.toString()),n({status:wx.globalData.status,valueData:e.buffer})):1!=wx.globalData.measureMode&&2!=wx.globalData.measureMode||n({})}(t);break;case 35:var e=t.param;wx.globalData.scaling=e.getInt16(2,!0)}})),wx.globalData.arrayQueue10secidx%1e3==0&&(r.insHeartRate=Number(wx.globalData.insHeartRate))}}))},ht.prototype.submitCommands=function(t,e,n,r){var a,i="";0==wx.globalData.measureMode&&-1==t&&(i=U.staticCommand(wx.globalData.measureTimeLength),a=U.str2ab(i)),-1!=t&&(i=U.IssueaAnOrder(t).command,a=U.str2ab(i)),this.deviceId=wx.globalData.deviceId;var o="";wx.writeBLECharacteristicValue({deviceId:e,serviceId:n,characteristicId:r,value:a,success:function(e){0==t?o="快速测量模式":1==t?o="睡眠模式":2==t?o="获取设备SN号":3==t?o="停止模式":4==t?o="上传历史数据":5==t?o="24小时监测模式":6==t?o="清除历史数据":-1==t&&(o="静态测量时长自定义"),console.log("writeBLECharacteristicValue success======="+o,e.errMsg)},complete:function(t){console.log("下面命令回调--"+o,t)}})},ht.prototype.closeBluetoothAdapter=function(){wx.closeBluetoothAdapter(),this._discoveryStarted=!1},ht.prototype.rungrid=function(t,e,n){var r=this.ctx3,a=n/40,i=e/80;r.lineWidth=this.smallGridlineWidth,console.log("ctx.lineWidth",r.lineWidth),r.strokeStyle=this.smallGrideLineColor,r.beginPath();for(var o=0;o<=280;o++){var s=o*i;r.moveTo(s,0),r.lineTo(s,n)}for(var c=0;c<=280;c++){var l=c*a;r.moveTo(0,l),r.lineTo(e,l)}for(r.stroke(),r.lineWidth=this.BigGridlineWidth,r.strokeStyle=this.BigGrideLineColor,r.beginPath(),o=0;o<=280;o+=5)s=o*i,r.moveTo(s,0),r.lineTo(s,n);for(c=0;c<=280;c+=5)l=c*a,r.moveTo(0,l),r.lineTo(e,l);r.stroke(),r.beginPath(),r.draw()},ht.prototype.drawGrid=function(t){var e=this;wx.createSelectorQuery().select("#"+t).context((function(t){e.ctx3=t.context})).exec(),wx.createSelectorQuery().select("#"+t).boundingClientRect(function(t){e.rungrid(100,t.width,t.height)}.bind(e)).exec()},ht.prototype.clearDraw=function(){clearInterval(this.ecgTimer),clearInterval(wx.globalData.ecgTimer),clearInterval(this.queToArr),this.ecgTimer=null,wx.globalData.ecgTimer=null,this.queToArr=null,wx.closeBLEConnection({deviceId:this.deviceId}),wx.globalData={stop:!1,url:"",canTimer:null,measureMode:0,valueArr:[],Voltagevalue:!1,valueNum:0,status:0,measureTimeLength:0,valueHandleOne:!0,getEcgNameUpload:"",deviceSN:"",deviceId:"",serviceId:"",count:0,path:"https://api-test.995120.cn",baseUrl:"http://api-dev.995120.cn",uuid:"e1d495e7beb311ebbfc79e874d1faa1d",reportNo:"",Authorization:"",SERVICE_ID:"",CHARACTERISTIC_ID:"",ecgData:null,ecgTimer:null,dataarr:[],dataarridx:0,currwidth:0,mb:null,crc:null,cmd:null,msgLength:null,bat:null,seq:null,temp:null,length:null,index:null,scaling:2e3,medLvbo:null,smoothLvbo:null,arrayQueue:null,arrayQueue10sec:null,arrayQueue10secidx:0,arrayQueue10secidxhr:0,insHeartRate:70,onesec:0,onelen:0}},ht.prototype.runMan=function(t,e,n,r){var a=this,i=a.ctxq;function o(){if(wx.globalData.dataarr&&0<wx.globalData.dataarr.length){var t=wx.globalData.dataarr;i.lineWidth=a.ecgLineWidth,i.strokeStyle=a.ecgLineColor,i.beginPath();var e=!0;i.moveTo(0,0);for(var n=0;n<t.length;n++){var r=t[n];null!=r&&null!=r.y&&(0==r.y?e=!0:0!=r.y&&(e&&(i.moveTo(r.x,r.y),e=!1),i.lineTo(r.x,r.y)))}i.stroke(),i.beginPath(),i.draw()}}i.clearRect(0,0,e,n),clearInterval(a.ecgTimer),0!=r?a.ecgTimer=setInterval(o,10):o()},ht.prototype.drawMan=function(t,e){var n=this;wx.createSelectorQuery().select("#"+t).context((function(t){n.ctxq=t.context})).exec(),wx.createSelectorQuery().select("#"+t).boundingClientRect(function(t){var r=parseInt(t.width/2),a=parseInt(t.height/2);n.ctxq.clearRect(0,0,r,a),n.runMan(100,t.width,t.height,e)}.bind(n)).exec()};var gt=ht,ft={respCode:"",respMsg:"",code:""};function vt(t){var e=window.location.toString().split("?");if(1<e.length)for(var n,r=e[1].split("&"),a=0;a<r.length;a++)if(null!=(n=r[a].split("="))&&n[0]==t)return n[1]}var pt=n(904),mt=n(15);var bt=n(904),yt=n(15);function xt(t){return(parseInt(t,10)>>>0).toString(16)}function wt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function It(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function Ct(t,e,n){return e&&It(t.prototype,e),n&&It(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}var St=function(){function t(){wt(this,t),this.obj=new Object,this.Status=null,this.mb=new Object,this.scaling=2e3,this.newSeq=0,this.dataarridx=0,this.currwidth=0,this.medLvbo=new U.MedLvbo(250,25),this.smoothLvbo=new U.smooth,this.arrayQueue=new U.ArrayQueue,this.valueNum=0,this.arrayQueue10secidx=0}return Ct(t,[{key:"DataAnalysis",value:function(){var t,e=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:375,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,a=2<arguments.length?arguments[2]:void 0,i=3<arguments.length?arguments[3]:void 0,o=U.ab2hex(a);switch(this.currwidth=n,U.EcgInteractive(o,(function(t){e.mb=t})),r){case 0:return i(a);case 1:i(this.mb);break;case 2:this.processing(o,this.mb,(function(t){i(t)}));break;case 3:this.obj={},"0x52"===this.mb.cmd&&(t=U.DeviceId(o),this.obj.SN=t,i(this.obj));break;case 4:this.obj={},"0x23"===this.mb.cmd&&i("版本问题暂时不获取版本号")}}},{key:"processing",value:function(t,e,n){switch(this.obj.electricity=this.EquipmentElectric(t),this.obj.remaining=this.remainings(e),(this.obj.mb=e).cmd){case"0x25":console.log("0x25");break;case"0x22":this.setItemToQue(e,(function(t){n(t)}));break;case"0x23":var r=e.param;this.scaling=r.getInt16(2,!0)}}},{key:"EquipmentElectric",value:function(t){if("5b22"==t.substr(0,4))return U.EquipmentElectric(t)}},{key:"remainings",value:function(t){return U.remaining(t.seq)}},{key:"setItemToQue",value:function(t,e){this.obj.newSeq=Number(t.seq);for(var n=(t=t.param).byteLength,r=11;r<n&&!(n<r+2);r+=2){755<this.dataarridx&&(this.dataarridx=0);var a={},i=this.dataarridx++,o=(o=i*this.currwidth/750).toFixed(2),s=50*(s=t.getInt16(r,!0))/this.scaling,c=[];c.push(s),this.obj.valueArr=c,70!=(c=U.qrs_det(s,this.arrayQueue10secidx))&&(this.obj.insHeartRate=Math.floor(c)),this.arrayQueue10secidx++,7500==this.arrayQueue10secidx&&(this.arrayQueue10secidx=0),s=this.medLvbo.init(s),s=120-(s=this.smoothLvbo.init(s))/2,a.x=o,a.y=s,a.idx=i,this.obj.mapping=a,e(this.obj)}}}]),t}();at=function(){function t(){wt(this,t),this.ctx="",this.CanvasgridLineWidth="",this.CanvasgridStrokeStyle="",this.ctxq="",this.CanvasmanLineWidth="",this.CanvasmanStrokeStyle="",this.arrayQueue=new U.ArrayQueue,this.queToArrTimer="",this.dataarr=[],this.ecgLineWidth=""}return Ct(t,[{key:"init",value:function(t){console.log(t),this.ctx=t.Canvasgrid.getContext("2d"),this.CanvasgridLineWidth=t.CanvasgridLineWidth||.3,this.CanvasgridStrokeStyle=t.CanvasgridStrokeStyle||"red",this.rungrid(100,this.ctx.canvas.width,this.ctx.canvas.height),this.ctxq=t.Canvasman.getContext("2d"),this.CanvasmanLineWidth=t.CanvasmanLineWidth||2,this.CanvasmanStrokeStyle=t.CanvasmanStrokeStyle||"#FC3159",this.ecgLineWidth=this.ctxq.canvas.width,this.drawMan(this.ctxq.canvas.width,this.ctxq.canvas.height,10),void 0!==t.CanvasmanData&&(this.arrayQueue.push(t.CanvasmanData),this.queToArrTimer=setInterval(this.queToArr,80))}},{key:"rungrid",value:function(t,e,n){var r=n/40,a=e/80;this.ctx.lineWidth=this.CanvasgridLineWidth,this.ctx.strokeStyle=this.CanvasgridStrokeStyle,this.ctx.beginPath();for(var i=0;i<=280;i++){var o=i*a;o=Math.ceil(o),this.ctx.moveTo(o+.5,.5),this.ctx.lineTo(o+.5,n+.5)}for(var s=0;s<=280;s++){var c=s*r;c=Math.ceil(c),this.ctx.moveTo(.5,c+.5),this.ctx.lineTo(e+.5,c+.5)}for(s=0;s<=280;s+=6)c=s*r,c=Math.ceil(c),this.ctx.moveTo(.5,c+.5),this.ctx.lineTo(e+.5,c+.5);for(i=0;i<=280;i+=6)o=i*a,o=Math.ceil(o),this.ctx.moveTo(o+.5,.5),this.ctx.lineTo(o+.5,n+.5);this.ctx.stroke()}},{key:"drawMan",value:function(t,e,n){var r=parseInt(t/2),a=parseInt(e/2);this.ctxq.clearRect(0,0,r,a),this.runMan(100,t,e,n)}},{key:"runMan",value:function(t,e,n,r){clearInterval(null),0!=r?setInterval(this.drawBufToCanMem,10):this.drawBufToCanMem()}},{key:"drawBufToCanMem",value:function(){if(this.dataarr&&0<this.dataarr.length){var t=this.dataarr;ctxq.lineWidth=this.ecgLineWidth,ctxq.strokeStyle=that.ecgLineColor,ctxq.beginPath(),ctxq.moveTo(0,0);var e=!0;ctxq.moveTo(0,0);for(var n=0;n<t.length;n++){var r=t[n];null!=r&&null!=r.y&&(0==r.y?e=!0:0!=r.y&&(e&&(ctxq.moveTo(r.x,r.y),e=!1),ctxq.lineTo(r.x,r.y)))}ctxq.stroke(),ctxq.beginPath(),ctxq.draw()}}},{key:"queToArr",value:function(){if(0<this.arrayQueue.size()){for(var t=void 0,e=0;e<20;e++){var n=this.arrayQueue.pop();if(null==n)break;t=this.dataarr[n.idx]=n}if(null!=t)for(var r=t.idx+1;r<t.idx+5;r++){var a={y:0};a.idx=r,this.dataarr[r]=a}}}}]),t}();const Dt={option:U,ecgList:K,basicLibwx:$,measure:function(t){return Z.canvasgrid=t.canvasgrid,Z.canvasman=t.canvasman,Z.smallGridlineWidth=parseInt(t.smallGridlineWidth)||.3,Z.smallGrideLineColor=t.smallGrideLineColor||"#333",Z.BigGridlineWidth=parseInt(t.BigGridlineWidth)||.4,Z.BigGrideLineColor=t.BigGrideLineColor||"#444",Z.ecgLineWidth=parseInt(t.ecgLineWidth)||1,Z.ecgLineColor=t.ecgLineColor||"#32CD32",Z.toDrawData=t.ecgRates,Z.filtering=t.filtering,Z.canvasWH.width=t.canvasWH-48,t=Z.toDrawData,console.log(),Z.ctx=Z.canvasgrid.getContext("2d"),function(t,e,n){var r=e/40,a=t/80;Z.ctx.lineWidth=Z.smallGridlineWidth,Z.ctx.strokeStyle=Z.smallGrideLineColor,Z.ctx.beginPath();for(var i=0;i<=280;i++){var o=i*a;o=Math.ceil(o),Z.ctx.moveTo(o+.5,.5),Z.ctx.lineTo(o+.5,e+.5)}for(var s=0;s<=280;s++){var c=s*r;c=Math.ceil(c),Z.ctx.moveTo(.5,c+.5),Z.ctx.lineTo(t+.5,c+.5)}for(s=0;s<=280;s+=6)c=s*r,c=Math.ceil(c),Z.ctx.moveTo(.5,c+.5),Z.ctx.lineTo(t+.5,c+.5);for(i=0;i<=280;i+=6)o=i*a,o=Math.ceil(o),Z.ctx.moveTo(o+.5,.5),Z.ctx.lineTo(o+.5,e+.5);return Z.ctx.stroke(),function(t){return-1==t.indexOf(",")?(console.log("没有逗号",t),function(t){for(var e=20*Z.dataIdx,n=void 0,r=0;r<625;r++){var a=t[e+r],i={},o=Z.dataArrIdx++,s=o*Z.canvasWH.width/625;a=100-50*a/126;i.x=s,i.y=a,i.idx=o,Z.arrList[o]=i,n=i}if(null!=n)for(var c=n.idx+1;c<n.idx+5;c++){var l={y:0};l.idx=c,Z.arrList[c]=l}return Z.dataIdx++,Z.dataarr=Z.arrList,tt()}(function(t){return t&&0!=t.length?function(t){var e=t.length/2,n=[];console.log("convertRawData",e);for(var r=0;r<e;r++)r<10&&console.log(t[2*r+1]+"---"+t[2*r]),n[r]=function(t){return 32767.5<t&&(t|=-65536),t}(parseInt("0x"+t[2*r+1]+t[2*r]));return n}(function(t){var e=t.length>>1;console.log("get",e);for(var n=[],r=e;0<=--r;)n[r]=t.substr(2*r,2);return n}(t)):[]}(t))):(t=t.split(","),console.log(t),function(t){console.log("有逗号处理",t);for(var e=+Z.dataIdx,n=[],r=0;r<t.length;r++){var a=t[e+r]/Number(Z.filtering);n[r]=a}var i=function(t){return Math.min.apply(null,t)}(n),o=function(t){return Math.max.apply(null,t)}(n),s=function(t){for(var e=0,n=0;n<t.length;n++)e+=t[n];return~~(e/t.length*100)/100}(n),c=o+i-2*s;45<c&&(c=45),c<-45&&(c=-45);for(var l=0;l<n.length;l++){var u=n[e+l],h={},d=Z.dataArrIdx++,g=d*Z.canvasWH.width/t.length;u=80-80*u+c;h.x=g,h.y=u,h.idx=d,Z.arrList[d]=h}return Z.dataIdx++,Z.dataarr=Z.arrList,tt()}(t))}(n)}(canvasman.width,canvasman.height,t)},synEcgwx:ct,basicLibswx:gt,SignIn:function(t){console.log(t);var e,n=[];return t.scopes.map((function(t){n.push(encodeURIComponent(t))})),e=n.join("+").toString(),new Promise((function(n,r){var a;"error_description=access+denied"!==window.location.href.split("&")[1]?void 0===vt("code")?(a="https://oauth-login.cloud.huawei.com/oauth2/v3/authorize?response_type=code&access_type=offline&client_id=".concat(t.appid,"&scope=").concat(e,"&redirect_uri=").concat(encodeURIComponent(t.redirectUri)),document.location=a):(ft.respCode="000",ft.respMsg="获取code成功",ft.code=decodeURIComponent(vt("code")),n(ft)):(ft.respCode=1001,ft.respMsg="获取code失败",r(ft))}))},LowLattice:function(t){console.log(t),function(t,e,n,r,a){console.log(r.toString());var i=e/40,o=t/80;n.lineWidth=.2,n.strokeStyle=r.toString(),n.beginPath();for(var s=0;s<=280;s++){var c=s*o;c=Math.ceil(c),n.moveTo(c+.5,.5),n.lineTo(c+.5,e+.5)}for(r=0;r<=280;r++){var l=r*i;l=Math.ceil(l),n.moveTo(.5,l+.5),n.lineTo(t+.5,l+.5)}var u,h,d=0;for(r=0;r<=280;r+=5)d++,l=r*i,l=Math.ceil(l),4==d?u=l:6==d&&(h=l),n.moveTo(.5,l+.5),n.lineTo(t+.5,l+.5);var g,f,v,p,m=0;for(s=0;s<=280;s+=5){switch(m++,c=s*o,c=Math.ceil(c),m){case 1:g=c;break;case 2:f=c;break;case 3:v=c;break;case 4:p=c}n.moveTo(c,0),n.lineTo(c,e)}for(s=0;s<=280;s+=25)0<s&&(n.stroke(),n.beginPath(),n.lineWidth=.4,n.strokeStyle=a,c=s*o,c=Math.ceil(c),n.moveTo(c+.5,.5),n.lineTo(c+.5,e+.5)),n.stroke();n.stroke(),n.beginPath(),n.lineWidth=.8,n.strokeStyle="rgba(0,0,0,0.20)",n.moveTo(g+.5,h+.5),n.lineTo(f+.5,h+.5),n.lineTo(f+.5,u+.5),n.lineTo(v+.5,u+.5),n.lineTo(v+.5,h+.5),n.lineTo(p+.5,h+.5),n.stroke()}(t.width,t.height,t.canss.getContext("2d"),t.rowstrokeStyle,t.colstrokeStyle)},toEcgdata:function(t,e){try{var n=function(t){return t?(t=t.split(" ")[0].split("-"),new Date(t[0],t[1]-1,t[2])):new Date}(e);if(!t)return;var r=t.split(","),a=[];console.log("pointstrArr500:"+r.length);for(var i=0;i<r.length;i+=2)a.push(r[i]);if(0==a.length)return;console.log("pointstrArr:"+a.length);for(var o=a.length,s=parseInt(o/250),c=new ArrayBuffer(20+521*s),l=new DataView(c),u=(w=l,I=n,(C=new ArrayBuffer(4))[0]=1,C[1]=0,C[2]=0,C[3]=0,mt.buf(w,0,C),mt.b(w,4,1),function(t,e,n){var r=pt.getShortYear(n);t.setInt8(5,r),r=n.getMonth()+1,t.setInt8(6,r),r=n.getDate(),t.setInt8(7,r),r=n.getHours(),t.setInt8(8,r),r=n.getMinutes()+1,t.setInt8(9,r),n=n.getSeconds(),t.setInt8(10,n)}(w,0,I),mt.g(w,11,0),mt.g(w,15,0),mt.b(w,19,0),20),h=0,d="",g=0,f=0;f<s;f++){b=l,y=u,x=h,mt.g(b,y,x),mt.b(b,y+4,0),mt.b(b,y+5,0),mt.s(b,y+6,0),mt.s(b,y+8,0),mt.b(b,y+10,0),mt.s(b,y+11,0),mt.s(b,y+13,0),mt.s(b,y+15,0),mt.g(b,y+17,0);for(var v=u+21,p=250*f;p<250*(f+1);p++){var m=parseInt(Number(a[p])/1e4);l.setInt16(v,m,!0),v+=2,g<625&&(d=d+m+",",g++)}0<d.length&&(d=d.substr(0,d.length-2)),u+=521,h+=1}return{length:s,buffer:c,buf25:d}}catch(t){return}var b,y,x,w,I,C},toEcgdataT3:function(t,e){try{var n=function(t){return t?(t=t.split(" ")[0].split("-"),new Date(t[0],t[1]-1,t[2])):new Date}(e);if(!t)return;var r=t.split(",");if(0==r.length)return;console.log("pointstrArr:"+r.length);for(var a=r.length,i=parseInt(a/250),o=new ArrayBuffer(20+521*i),s=new DataView(o),c=(x=s,w=n,(I=new ArrayBuffer(4))[0]=1,I[1]=0,I[2]=0,I[3]=0,yt.buf(x,0,I),yt.b(x,4,1),function(t,e,n){var r=bt.getShortYear(n);t.setInt8(5,r),r=n.getMonth()+1,t.setInt8(6,r),r=n.getDate(),t.setInt8(7,r),r=n.getHours(),t.setInt8(8,r),r=n.getMinutes()+1,t.setInt8(9,r),n=n.getSeconds(),t.setInt8(10,n)}(x,0,w),yt.g(x,11,0),yt.g(x,15,0),yt.b(x,19,0),20),l=0,u="",h=0,d=0;d<i;d++){m=s,b=c,y=l,yt.g(m,b,y),yt.b(m,b+4,0),yt.b(m,b+5,0),yt.s(m,b+6,0),yt.s(m,b+8,0),yt.b(m,b+10,0),yt.s(m,b+11,0),yt.s(m,b+13,0),yt.s(m,b+15,0),yt.g(m,b+17,0);for(var g=c+21,f=250*d;f<250*(d+1);f++){var v,p=parseInt(Number(r[f]));h<625&&(0==(v=xt(p)).length?v="0000":1==v.length?v="000"+v:2==v.length?v="00"+v:3==v.length&&(v="0"+v),u+=v=v.substr(v.length-2,2)+v.substr(v.length-4,2),h++),s.setInt16(g,p,!0),g+=2}console.log("i25",h),console.log("buf25",u),c+=521,l+=1}return{length:i,buffer:o,buf25:u}}catch(t){return void console.log("toecgt3",t)}var m,b,y,x,w,I},H5Ecg:St,CanvaH5:at};console.log(U)})(),r.default})()}));
